# Changelog

All notable changes to Pfft_maker will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

---

## [Unreleased]

### Added - 2025-10-18

#### LoRAライブラリ機能

**新機能:**
- LoRAファイルの一元管理機能
- .safetensorsファイルの自動スキャン
- Civitai.infoメタデータの自動読み込み
- LoRA専用タブをライブラリパネルに追加

**主な機能:**

1. **LoRAスキャン**
   - LoRAフォルダを再帰的にスキャン
   - .safetensorsファイルを自動検出
   - .civitai.infoと.jsonからメタデータを読み込み
   - トリガーワード、推奨重み、タグ情報を取得

2. **ライブラリ管理**
   - CSV形式でLoRA情報を永続化
   - カテゴリ別の階層表示（フォルダ構造を反映）
   - 検索・フィルタリング機能
   - ダブルクリックで`<lora:filename:0.8>`形式のプロンプトを挿入

3. **メタデータ対応**
   - Civitai.info: trainedWords（トリガーワード）、baseModel、tags、modelId
   - JSON: activation text、preferred weight
   - 自動的にプロンプト形式に変換（例: `<lora:model:0.8>, trigger words`）

4. **UI統合**
   - ライブラリパネルに「🎨LoRA」タブを追加
   - スキャンボタンで最新のLoRAファイルを取り込み
   - 再読み込みボタンでCSVから再読み込み
   - カテゴリフィルタと検索バーで効率的に検索

**新規ファイル:**
- `src/core/lora_parser.py`: LoRAファイル解析機能
- `src/core/lora_library_manager.py`: LoRAライブラリ管理機能

**変更ファイル:**
- `src/config/settings.py`: LoRAディレクトリ設定を追加
- `src/ui/settings_dialog.py`: LoRAディレクトリ設定UIを追加
- `src/ui/library_panel.py`: LoRAタブを追加（約250行追加）

**データファイル:**
- `data/lora_library.csv`: LoRAライブラリの保存先（自動生成）

**技術詳細:**
- .safetensorsファイルの再帰的スキャン
- JSONメタデータの自動パース
- BOM付きUTF-8でのCSV保存（Excel互換）
- プログレスダイアログによる進捗表示

**ユーザー影響:**
- LoRAファイルの管理が容易に
- トリガーワードを手動で調べる手間が不要
- プロンプト形式が自動生成されるため入力ミスが減少
- フォルダ構造がカテゴリとして反映され整理しやすい

---

### Added - 2025-10-15

#### UX改善 - ワークフロー最適化とUI改善

**コンソール自動最小化:**
- アプリ起動時にコマンドコンソールを自動的に最小化
- Windows環境でのユーザー体験向上

**カテゴリ編集機能:**
- シーンライブラリのカテゴリを編集可能に
- カテゴリの追加・削除・名前変更に対応
- カテゴリ選択フィールドに「編集」ボタンを追加

**ワークフロー修正:**
- 「完成」チェックボックスを削除（機能の重複を解消）
- 「💾 シーンに保存」ボタンをシーン名の下に移動
- 「🖼️ シーンを保存（プレビューへ表示）」ボタンを新設
- プレビューは明示的な操作でのみ更新する設計に変更

**保存機能の整理:**
- 「📚 ライブラリ保存」→「📚 シーンをテンプレート保存」に名称変更
- 「💾 作品を保存」ボタンを作品名フィールド横に追加
- 作品全体の保存・読み込みを明確化
- シーン単位と作品全体の保存を明確に区別

**シーン読み込み機能の改善:**
- 「📚 挿入」→「シーン読み込み」に名称変更
- プロンプト編集エリアに直接読み込む方式に変更
- 上書き時に確認メッセージを表示

**プレビュー機能の改善:**
- 「ファイル出力」ボタンを追加
- コピー・ファイル出力時にシーンヘッダー（━━━ シーン1 ━━━）を自動削除
- 1シーン1行、改行区切りで出力（Prompts from file or textbox形式準拠）

**UIレイアウト改善:**
- シーン操作ボタン群（追加・複製・削除・読み込み）をタイトル横に移動
- より効率的で直感的なワークフローを実現

**新規ファイル:**
- `src/ui/category_edit_dialog.py`: カテゴリ編集ダイアログ

**変更ファイル:**
- `run.py`: コンソール自動最小化機能
- `src/ui/scene_editor_panel.py`: レイアウト変更、完成チェックボックス削除、作品保存ボタン追加
- `src/ui/scene_save_dialog.py`: カテゴリ編集機能追加
- `src/ui/preview_panel.py`: ファイル出力機能、コピー機能改善
- `src/ui/main_window.py`: 作品保存ボタンとの連携

**ユーザー影響:**
- ワークフローが明確化され、混乱が減少
- 保存機能が整理され、目的に応じた保存が可能に
- プレビュー出力がPrompts from file形式に完全準拠
- UI操作が効率化

**コミット:**
- `2fab085` - feat: UX改善 - ワークフロー最適化とUI改善

---

### Added - 2025-10-14

#### シーンライブラリ機能 - UX改善4提案完全実装

**新機能:**
- シーンライブラリ：完成したシーンを保存・再利用可能に
- バッチ保存：複数シーンを一括でライブラリに保存（Ctrl+Shift+B）
- ライブラリパネル統合：シーンライブラリタブを左パネルに追加

**UX改善（4提案）:**

1. **✅ 完成チェック時に自動保存プロンプト**
   - 完成にチェック → 即座に「保存しますか？」ダイアログ表示
   - タイミングを逃さない自然な保存フロー
   - 保存忘れを防止

2. **📚 保存ボタンのレイアウト改善**
   - 保存ボタンを完成チェックの横に配置（視覚的な動線改善）
   - セクション分け（「━━━ ブロック操作 ━━━」「━━━ シーン操作 ━━━」）で視認性向上
   - ボタン配置を再構成して自然な操作フローを実現

3. **一括保存機能（Ctrl+Shift+B）**
   - 30シーンなどを一括保存可能（従来の30回クリック → 1回の操作）
   - チェックボックスで選択的保存
   - 共通カテゴリ設定・タグ自動生成機能付き
   - メニューバー統合：ツール → シーンを一括保存

4. **🎬 シーンライブラリタブ（左パネル）**
   - ⭐ よく使うシーンTOP5（使用回数順）
   - 🕒 最近使ったシーン（最終使用日時順）
   - 全シーン一覧（カテゴリ別・検索可能）
   - ダブルクリックで即座に挿入
   - 常に見える場所に配置（発見性向上）

**新規ファイル:**
- `src/models/scene_library.py`: SceneLibraryItemモデル
- `src/core/scene_library_manager.py`: シーンライブラリ管理
- `src/ui/scene_save_dialog.py`: シーン保存ダイアログ
- `src/ui/scene_select_dialog.py`: シーン選択ダイアログ
- `src/ui/batch_scene_save_dialog.py`: バッチ保存ダイアログ
- `src/ui/block_edit_dialog.py`: ブロック編集ダイアログ
- `CUSTOM_PROMPT_GUIDE.md`: 自作プロンプトガイド

**変更ファイル:**
- `src/ui/scene_editor_panel.py`: 保存UI改善、シグナル追加
- `src/ui/library_panel.py`: シーンライブラリタブ追加（420行追加）
- `src/ui/main_window.py`: バッチ保存メニュー、シグナル連携
- `docs/USER_GUIDE.md`: UX改善機能の説明追加

**データファイル:**
- `data/scene_library.json`: シーンライブラリの保存先（自動生成）

**技術詳細:**
- シグナル/スロット方式でコンポーネント間連携
- PyQt6のQTreeWidgetでカテゴリ別階層表示
- 使用履歴（使用回数・最終使用日時・使用プロジェクト）の自動記録
- JSON形式でのデータ永続化

**ユーザー影響:**
- 作業効率が大幅に向上（30シーン保存が30回 → 1回）
- シーン再利用が容易に（よく使うシーンTOP5にワンクリックアクセス）
- 保存忘れ防止（完成チェック時の自動プロンプト）
- UIの発見性向上（保存ボタンが見つけやすい配置）

**コミット:**
- `fb19857` - feat: シーンライブラリ機能 - UX改善4提案完全実装

---

## [1.0.0] - 2025-10-14（想定）

### Added

#### テンプレート機能（FR-013）
- プロジェクト構成を保存・再利用できるテンプレート機能
- 構成テンプレート（プレースホルダー方式）
- 完全テンプレート（コピー方式）
- テンプレート管理UI（選択・削除・編集）
- テンプレートから新規プロジェクト作成

#### 自作プロンプトライブラリ（FR-004）
- ブロック単位でのプロンプト保存
- カテゴリ・タグ管理
- 使用履歴記録
- よく使うプロンプトTOP5表示
- ライブラリパネルに「✨自作プロンプト」タブ追加

#### コア機能
- 10,942プロンプトの一元管理
- ワイルドカードファイル読み込み
- 3カラムUI（ライブラリ・エディタ・プレビュー）
- 30シーン管理機能
- プロンプト出力（Stable Diffusion WebUI連携）
- BREAK処理（75トークンチャンク境界）

#### AI連携
- Claude API統合
- 自動ラベル生成（日本語ラベル付与）
- 3つのモード（通常・並列・Batch API）
- コスト見積もり表示

### Changed
- UIレイアウトの改善
- 検索機能の強化
- エラーハンドリングの改善

### Fixed
- CSV読み込み時のエンコーディング問題
- ワイルドカード形式の認識精度向上
- メモリリーク対策

---

## 開発履歴

### Phase 1: 基本機能（完了）
- プロジェクト構造設計
- ワイルドカード読み込み
- UIフレームワーク構築

### Phase 2: シーン管理（完了）
- シーン編集機能
- ブロック管理
- プレビュー機能

### Phase 3: ライブラリ統合（完了）
- プロンプト検索
- カテゴリ管理
- ワイルドカード展開

### Phase 4: 出力機能（完了）
- プロンプト出力
- Stable Diffusion連携
- バッチ処理

### Phase 5: テンプレート機能（完了）
- テンプレート保存/読み込み
- プロジェクトテンプレート
- 使用履歴管理

### Phase 6: UX改善（完了 - 2025-10-14）
- シーンライブラリ
- バッチ保存
- UI動線改善
- 自動保存プロンプト

---

## 今後の予定

### 短期（次回リリース候補）
- [ ] ドラッグ&ドロップによるブロック移動
- [ ] ブロックのコピー&ペースト
- [ ] シーン間のブロックコピー
- [ ] プロジェクト統計表示（総ブロック数、使用プロンプト数など）

### 中期
- [ ] ダークモード対応
- [ ] プロンプト履歴機能
- [ ] お気に入りシーン管理
- [ ] エクスポート形式の拡張（CSV、Excel）

### 長期
- [ ] プロンプト推奨機能（AI連携）
- [ ] ブロック自動整形
- [ ] プロジェクトバージョン管理
- [ ] チーム共有機能

---

## リリースノート作成ルール

### 変更タイプ
- **Added**: 新機能
- **Changed**: 既存機能の変更
- **Deprecated**: 非推奨化
- **Removed**: 削除された機能
- **Fixed**: バグ修正
- **Security**: セキュリティ関連

### 記載内容
1. 変更の概要（ユーザー視点）
2. 技術的詳細（開発者向け）
3. 影響範囲（破壊的変更の有無）
4. コミットハッシュ

---

**メンテナンス:** このCHANGELOG.mdは各機能リリース時に更新してください。
