# 問題11: 完成シーン判定基準の定義 - 解決記録

作成日: 2025-10-12
問題番号: 11
ステータス: ✅ 解決済み

---

## 問題の概要

**タイトル**: 完成シーン判定基準の定義

**問題内容**:
FR-018（プロンプトファイル出力）に「完成済みシーンのみ」オプションが存在するが、何をもって「完成」とするか明確な基準が定義されていない。

**該当箇所**:
- requirements.md: FR-011（30シーン管理）
- requirements.md: FR-018（プロンプトファイル出力）
- technical_requirements.md: models/scene.py

---

## 検討した選択肢

### 選択肢1: 手動マーク方式（採用）
- **概要**: ユーザーが明示的にチェックボックスで完成を指定
- **UI**: `[☑ 完成]`チェックボックスを表示
- **メリット**:
  - ユーザーの意図を正確に反映
  - 調整中のシーンを除外可能
  - プロンプトの有無に関わらず、ユーザーの判断で完成を決定
- **デメリット**:
  - チェック忘れがあると出力されない

### 選択肢2: 自動判定方式（不採用）
- **概要**: プロンプトブロックが1つ以上あれば自動的に完成とみなす
- **メリット**:
  - チェック漏れがない
  - 手間が少ない
- **デメリット**:
  - **調整中のシーンも出力されてしまう**（ユーザーの意図に反する）

### 選択肢3: 両方の組み合わせ（不採用）
- **概要**: 手動マークを優先、未マークの場合は自動判定
- **メリット**:
  - より柔軟な運用が可能
- **デメリット**:
  - **UIが複雑になる**
  - **ユーザーの意図が曖昧になる**

---

## 採用した解決策

**選択肢1: 手動マーク方式**を採用

**理由**:
ユーザーからの明確なフィードバック：
> 「心が全て完成していない、もしくは調整中のままプロンプトを出力することはあり得ません」

この発言から、ユーザーは**完成の判断を自分でコントロールしたい**という強い意志が確認された。

**プロジェクトの設計思想との一致**:
- 問題6で確立した「柔軟性重視」の設計思想に合致
- ユーザーが明示的に管理することで、意図しない出力を防ぐ

---

## 実施した変更

### 1. requirements.md FR-011の更新

**追加内容**:

```markdown
**完成シーン判定**:
- **手動マーク方式**: ユーザーが明示的にチェックボックスで完成を指定
- UIに`[☑ 完成]`チェックボックスを表示
- チェックされたシーンのみが出力対象となる
- プロンプトの内容や量に関わらず、ユーザーの判断で完成を決定

**UI表示例**:
```
[シーン: 1:保健室 ▼] [☑ 完成]  ← 完成したシーン
[シーン: 2:教室 ▼] [☐ 完成]    ← 調整中のシーン
[シーン: 3:屋上 ▼] [☐ 完成]    ← 未完成のシーン
```

**シーン状態**:
- **完成**: ✓チェック済み（出力対象）
- **未完成**: ☐チェックなし（出力除外）
- **編集中**: ★マーク表示（現在編集中のシーン）
```

---

### 2. requirements.md FR-010の更新

**JSONスキーマへの追加**:

```json
{
  "scenes": [
    {
      "scene_id": 1,
      "scene_name": "保健室での診察",
      "is_completed": true,  // ← 追加
      "created_date": "2025-01-15",
      "blocks": [...]
    }
  ]
}
```

---

### 3. requirements.md FR-018の更新

**「完成済みシーンのみ」オプションの動作を明確化**:

```markdown
**「完成済みシーンのみ」オプションの動作**:
- ☑チェックあり: `is_completed == true` のシーンのみ出力
- ☐チェックなし: すべてのシーン（プロンプトがあるシーン）を出力

**出力例**（30シーン中、3シーンのみ完成の場合）:
```
# 完成済みシーンのみ出力 → 3行のみ
clothed masturbation, school infirmary, BREAK __posing/arm__, BREAK masterpiece
deepthroat, classroom interior, BREAK __posing/leg__, BREAK best quality
exhibitionism, school rooftop, BREAK standing, spread legs, BREAK best quality
```
```

---

### 4. technical_requirements.md models/scene.pyの更新

**Sceneモデルの設計**:

```python
# models/scene.py
@dataclass
class Scene:
    """シーンモデル"""
    scene_id: int
    scene_name: str
    is_completed: bool = False  # 手動マーク方式: ユーザーがUIでチェックボックスで指定
    blocks: List['Block'] = field(default_factory=list)
    created_date: datetime = field(default_factory=datetime.now)

    def get_final_prompt(self) -> str:
        """最終プロンプトを生成

        Returns:
            1行のプロンプト文字列（カンマ区切り、BREAK処理済み）

        Note:
            - BREAK前後の処理はPromptBuilderが担当
            - ワイルドカード形式（__filename__）はそのまま出力
        """
        pass
```

**変更内容**:
- `is_completed: bool = False`フィールドを追加
- デフォルト値は`False`（未完成）
- コメントで「手動マーク方式」であることを明記

---

## 実装ガイドライン

### UIでの実装

**シーン編集パネル**:
```
┌─シーン編集────────────────┐
│シーン: [1:保健室 ▼] [☑ 完成]  │
│                              │
│[ブロック1] 📌固定             │
│ clothed masturbation         │
│ [編集][削][↑][↓]           │
│                              │
│[+ブロック] [+BREAK]          │
└──────────────────────────────┘
```

**プレビューパネル**:
```
┌─プレビュー────────────────┐
│【全シーン一覧】(30シーン)  │
│                           │
│ 1. clothed mast... ✓      │ ← is_completed == true
│ 2. deepthroat... ✓        │ ← is_completed == true
│ 3. exhibitionism...       │ ← is_completed == false
│ 4. handjob...             │
│ ...                       │
│ 30. final scene...        │
│                           │
│ 完成: 2/30シーン          │
└───────────────────────────┘
```

---

### 出力機能での実装

```python
# core/prompt_builder.py
def build_output_file(self, project: Project, completed_only: bool = True) -> List[str]:
    """出力ファイル用のプロンプトリストを構築

    Args:
        project: プロジェクトオブジェクト
        completed_only: Trueの場合、is_completed == trueのシーンのみ出力

    Returns:
        プロンプト文字列のリスト（1行 = 1シーン）
    """
    prompts = []

    for scene in project.scenes:
        # 完成済みシーンのみ出力する場合
        if completed_only and not scene.is_completed:
            continue

        # プロンプト構築
        prompt = self.build_scene_prompt(scene)
        prompts.append(prompt)

    return prompts
```

---

## 影響範囲

### 更新されたファイル
1. `requirements.md` (FR-011, FR-010, FR-018)
2. `technical_requirements.md` (models/scene.py)

### 新規作成されたファイル
- `ISSUE_11_RESOLVED.md` （本ファイル）

### 影響を受ける機能
- FR-011: 30シーン管理
- FR-018: プロンプトファイル出力
- UI: シーン編集パネル、プレビューパネル、出力ダイアログ

---

## テスト項目

### 単体テスト
- [ ] Scene.is_completedのデフォルト値がFalseであることを確認
- [ ] PromptBuilder.build_output_file()が completed_only=True の場合、is_completed==trueのシーンのみ返すことを確認
- [ ] PromptBuilder.build_output_file()が completed_only=False の場合、すべてのシーンを返すことを確認

### 統合テスト
- [ ] UIでチェックボックスをON/OFFした際、Scene.is_completedが正しく更新されることを確認
- [ ] プロジェクト保存→読み込み後、is_completedの状態が保持されることを確認
- [ ] 出力ダイアログで「完成済みシーンのみ」をONにした場合、完成シーンのみ出力されることを確認

### UI/UXテスト
- [ ] チェックボックスの視覚的フィードバックが明確であることを確認
- [ ] プレビューパネルで完成シーン数が正しく表示されることを確認
- [ ] 完成シーンが一目でわかる（✓マーク表示）ことを確認

---

## 補足事項

### なぜ自動判定を採用しなかったのか？

ユーザーの発言:
> 「心が全て完成していない、もしくは調整中のままプロンプトを出力することはあり得ません」

この発言から、以下のことが明確になった:
1. **完成の定義はユーザーの心理的状態に依存する**
2. **プロンプトの有無だけでは判断できない**
3. **調整中のシーンは絶対に出力したくない**

自動判定では「プロンプトがあれば完成」とみなすため、調整中のシーンも出力されてしまい、ユーザーの意図に反する。

### 今後の拡張可能性

もし将来的に「チェック忘れ防止」機能が必要になった場合、以下のような補助機能を追加できる（オプション）:

1. **警告表示**: 出力時に未チェックシーンの存在を警告
   ```
   ⚠ 注意: プロンプトがあるが未完成のシーンが5個あります
   [確認] [このまま出力] [キャンセル]
   ```

2. **一括チェック機能**: プロンプトがあるシーンをまとめてチェック
   ```
   [プロンプトがあるシーンをすべて完成にする]
   ```

ただし、これらは**Phase 1では実装しない**。

---

## 結論

問題11は**手動マーク方式**を採用することで解決した。

**キーポイント**:
- ✅ ユーザーの意図を正確に反映
- ✅ 柔軟性重視の設計思想に合致
- ✅ 調整中のシーンを確実に除外可能
- ✅ UIがシンプルで明確

**次のステップ**:
- 問題7（CSVカラム定義の整理）へ進む
- 問題9（シーン削除時の番号管理）へ進む

---

**承認日**: 2025-10-12
**承認者**: ユーザー
