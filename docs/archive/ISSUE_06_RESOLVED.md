# 問題6: 共通プロンプト挿入位置ロジックの曖昧さ - 解決

作成日: 2025-10-12
ステータス: ✅ 解決済み

---

## 問題の概要

**発見日**: 2025-01-15（ISSUES_AND_FIXES.md作成時）
**重要度**: 中優先（設計変更推奨）

### 問題内容

requirements.md の FR-012（共通プロンプト機能）において、共通プロンプトの挿入・管理方法に矛盾がありました。

**矛盾点**:
1. **設定画面の記述**: 「挿入位置: [BREAKの後 ▼]」→ 自動挿入・固定位置を示唆
2. **UI仕様の記述**: 共通プロンプトブロックを自由に移動できる（[↑][↓]ボタン）→ ユーザーが移動可能

この矛盾により、実装時に以下の問題が発生する可能性がありました：
- 実装者が迷う（どちらの仕様が正しいか不明）
- UIの挙動が不自然になる（一部のブロックだけ移動不可など）
- ユーザーの混乱を招く

---

## 検討した解決策

### 修正案A: 自動挿入（固定位置）

**概要**: 共通プロンプトを固定位置に自動挿入し、移動不可とする

**仕様**:
```
[ユーザーのブロック]
[BREAK]
[共通プロンプト: LoRA] ← 自動挿入（移動不可🔒）
[BREAK]
[共通プロンプト: 品質タグ] ← 自動挿入（移動不可🔒）
```

**メリット**:
- 全シーンで一貫性が保たれる
- 共通プロンプトの抜け漏れがない

**デメリット**:
- 柔軟性が低い（シーンごとの微調整ができない）
- UIの挙動が複雑（一部のブロックだけ特別扱い）
- 共通プロンプトが不要なシーンでも強制挿入

---

### 修正案B: 手動管理（自由配置）【✅ 採用】

**概要**: 共通プロンプトを「初期テンプレート」として扱う

**仕様**:
1. **新規シーン作成時**: 設定された共通プロンプトを自動挿入
2. **挿入後の扱い**: 通常のブロックとして扱い、ユーザーが自由に編集・移動・削除可能
3. **既存シーンへの影響**: なし（共通プロンプト設定変更時も既存シーンには反映されない）

**メリット**:
- ✅ 柔軟性が高い（シーンごとに微調整可能）
- ✅ UIの挙動が一貫（全ブロックが同じ操作可能）
- ✅ 実装がシンプル
- ✅ 共通プロンプトが不要なシーンでは削除できる
- ✅ ユーザーの設計思想（柔軟性重視）に合致

**デメリット**:
- 共通プロンプトの変更が既存シーンに反映されない（ただし、これは仕様として明確化すれば問題なし）

---

## 採用した解決策

**修正案B（手動管理）を採用**

**理由**:
1. ユーザーの柔軟性を重視する設計思想に合致
2. UIの挙動が一貫し、シンプル
3. 実装が容易
4. ユーザーからの承認を得た（2025-10-12）

---

## 実施した修正

### requirements.md (FR-012)

**修正前**:
```
#### FR-012: 共通プロンプト機能
**概要**: 全シーンに自動適用されるプロンプトを設定する

**シーン編集での表示**:
- 共通プロンプトブロックは 🔒 マーク付きで表示
- 個別編集可（そのシーンのみ変更）
```

**修正後**:
```
#### FR-012: 共通プロンプト機能
**概要**: 新規シーン作成時に自動挿入されるプロンプトのテンプレートを設定する

**動作仕様**:
- **新規シーン作成時**: 設定された共通プロンプトを自動挿入
- **挿入後の扱い**: 通常のブロックとして扱われ、ユーザーが自由に編集・移動・削除可能
- **既存シーンへの影響**: なし（共通プロンプト設定を変更しても、既存シーンには反映されない）

**メリット**:
- シーンごとに柔軟にカスタマイズ可能
- 共通プロンプトが不要なシーンでは削除できる
- UIの挙動が一貫（全ブロックが同じ操作可能）
```

---

## 実装への影響

### データモデル（models/block.py）

**変更不要**: 共通プロンプトも通常のブロックとして扱うため、既存の `Block` モデルで対応可能

```python
@dataclass
class Block:
    """ブロックモデル"""
    block_id: int
    type: BlockType  # FIXED_TEXT, WILDCARD, BREAK
    content: str
    source: Dict = field(default_factory=dict)
    # is_common フラグは不要（削除）
```

### プロジェクト管理（core/project_manager.py）

**新規シーン作成時の処理追加**:
```python
def create_new_scene(self, scene_id: int, project: Project) -> Scene:
    """新規シーン作成（共通プロンプトを自動挿入）"""
    scene = Scene(scene_id=scene_id, scene_name=f"シーン{scene_id}")

    # プロジェクトの共通プロンプト設定から初期ブロックを生成
    if project.common_prompts:
        block_id = 1
        for prompt_type, content in project.common_prompts.items():
            if content:  # 設定されている場合のみ挿入
                scene.blocks.append(Block(
                    block_id=block_id,
                    type=BlockType.FIXED_TEXT,
                    content=content
                ))
                block_id += 1

    return scene
```

### UI（ui/scene_editor_panel.py）

**変更不要**: すべてのブロックを同じ方法で扱うため、特別な処理は不要

---

## 確認事項

- ✅ requirements.md FR-012 を修正案Bに更新
- ✅ ユーザーの承認を得た
- ✅ 実装方針が明確化された
- ⏳ technical_requirements.md への反映（必要に応じて）
- ⏳ CLAUDE.md への反映（必要に応じて）

---

## まとめ

共通プロンプト機能を「初期テンプレート」として扱うことで、以下を達成しました：

1. **仕様の明確化**: 新規シーン作成時のみ自動挿入、その後は通常ブロックとして扱う
2. **柔軟性の確保**: ユーザーが自由に編集・移動・削除可能
3. **実装の簡素化**: 特別な処理が不要、既存のブロック管理機構を利用
4. **UIの一貫性**: すべてのブロックが同じ挙動

この設計により、ユーザーの柔軟性を重視する設計思想に沿った、使いやすい機能となります。
