# 問題14: ワイルドカード展開候補表示の簡略化 - 解決記録

作成日: 2025-10-12
問題番号: 14
ステータス: ✅ 解決済み

---

## 問題の概要

**タイトル**: ワイルドカード展開候補表示の実装困難性

**問題内容**:
プレビューで「ワイルドカード展開候補」を表示する際、複数のワイルドカードがシーンに含まれている場合、全組み合わせが膨大になり表示不可能。

**該当箇所**:
- requirements.md: FR-009（リアルタイムプレビュー）
- technical_requirements.md: ui/preview_panel.py

---

## 問題の詳細

### 現状の仕様（修正前）

```
プレビューで「ワイルドカード展開候補」を表示
```

### 問題点

**全組み合わせの爆発的増加**:
```
シーンに3個のワイルドカードがある場合:
- __posing/arm__ (10候補)
- __posing/leg__ (8候補)
- __angle/camera__ (15候補)

全組み合わせ: 10 × 8 × 15 = 1,200パターン

→ 表示不可能！UI上で1,200パターンを表示するのは現実的ではない
```

**さらに複雑なケース**:
```
シーンに5個のワイルドカードがある場合:
- __tipo_play__ (90候補)
- __posing/arm__ (10候補)
- __posing/leg__ (8候補)
- __angle/camera__ (15候補)
- __キャラ/SAYA__ (1候補)

全組み合わせ: 90 × 10 × 8 × 15 × 1 = 108,000パターン

→ 完全に不可能！
```

**問題の本質**:
- 全組み合わせを計算するのは**組み合わせ爆発**の典型的な問題
- UIに表示しきれない
- 計算時間も膨大
- ユーザーにとって有用性が低い（108,000パターン見せられても困る）

---

## 採用した解決策

**個別ファイルごとに候補を表示（全組み合わせは表示しない）**

### 新しい表示方式

```
【ワイルドカード展開候補】
posing/arm (10候補):
 • arms crossed
 • arms up
 • arms behind back
 • arms at sides
 • arms behind head
 （残り5候補...）

posing/leg (8候補):
 • standing
 • sitting
 • kneeling
 • spread legs
 • lying down
 （残り3候補...）

angle/camera (15候補):
 • from above
 • from below
 • from side
 • close-up
 • wide shot
 （残り10候補...）
```

### 表示ルール

1. **個別ファイルごとに表示**:
   - 各ワイルドカードファイルの候補を個別に表示
   - 全組み合わせは計算しない

2. **最大5候補まで表示**:
   - 各ファイルの最初の5候補のみ表示
   - 6候補目以降は「（残りN候補...）」と表示

3. **ファイル名と候補数を明示**:
   - `posing/arm (10候補):` のように総数を表示
   - ユーザーが候補数を把握できる

---

## 実施した変更

### 1. requirements.md FR-009の更新

**修正前**:
```markdown
**表示内容**:
- 最終プロンプト（1行形式）
- ワイルドカード展開候補（可能であれば）
- 文字数カウント（推奨: ~500文字）
```

**修正後**:
```markdown
**表示内容**:
- 最終プロンプト（1行形式）
- ワイルドカード展開候補（個別ファイルのみ表示）
- 文字数カウント（推奨: ~500文字）

**ワイルドカード展開候補の表示方式**:
- **個別ファイルごとに候補を表示**（全組み合わせは表示しない）
- 理由: 複数ワイルドカードの全組み合わせは膨大になるため（例: 10×8×15 = 1,200パターン）
- 表示例: （省略）
```

### 2. requirements.md 4.4（右カラム：プレビュー）の更新

**UIモックアップにワイルドカード展開候補の表示例を追加**:
```
┌─プレビュー────────────────┐
│【現在編集中のシーン】      │
│clothed masturbation,      │
│BREAK,                     │
│__posing/arm__,            │
│...                        │
│                           │
│───────────────────────── │
│【ワイルドカード展開候補】  │
│posing/arm (10候補):       │
│ • arms crossed            │
│ • arms up                 │
│ • arms behind back        │
│ （残り7候補...）          │
│                           │
│───────────────────────── │
│【全シーン一覧】(30シーン) │
│ ...                       │
└───────────────────────────┘
```

### 3. technical_requirements.md PreviewPanelクラスの更新

**追加メソッド**:
- `update_wildcard_candidates(scene: Scene)`: ワイルドカード展開候補を更新
- `load_wildcard_candidates(wildcard_path: str, limit: int)`: ワイルドカードファイルから候補を読み込み
- `display_candidates(wildcard_path: str, candidates: List[str])`: UI表示を更新

**実装例**:
```python
def update_wildcard_candidates(self, scene: Scene):
    """ワイルドカード展開候補を更新

    Note:
        個別ファイルごとに候補を表示（全組み合わせは表示しない）。
        各ファイルの候補を最大5個まで表示し、残りは「（残りN候補...）」と表示。
    """
    # シーン内のワイルドカードブロックを抽出
    wildcard_blocks = [b for b in scene.blocks
                      if b.type == BlockType.WILDCARD]

    # 各ワイルドカードファイルの候補を取得（最大5個）
    for block in wildcard_blocks:
        wildcard_path = block.content  # 例: __posing/arm__
        candidates = self.load_wildcard_candidates(wildcard_path, limit=5)
        # UI表示を更新
        self.display_candidates(wildcard_path, candidates)
```

---

## 実装への影響

### パフォーマンス改善効果

**計算量の比較**:

| シーン構成 | 全組み合わせ方式 | 個別ファイル方式 |
|-----------|----------------|----------------|
| 2ワイルドカード (10×8) | 80パターン | 18候補（10+8） |
| 3ワイルドカード (10×8×15) | 1,200パターン | 33候補（10+8+15） |
| 5ワイルドカード (90×10×8×15×1) | 108,000パターン | 124候補（90+10+8+15+1） |

**結論**: 計算量が**線形**になる（O(n) vs O(n!)）

### UI表示の改善

**全組み合わせ方式の問題**:
```
【ワイルドカード展開候補】（全組み合わせ）
1. arms crossed, standing, from above
2. arms crossed, standing, from below
3. arms crossed, standing, from side
...
1,200. arms behind head, lying down, wide shot

→ スクロール地獄、見るのが不可能
```

**個別ファイル方式のメリット**:
```
【ワイルドカード展開候補】（個別ファイル）
posing/arm (10候補):
 • arms crossed
 • arms up
 ...（省略）

posing/leg (8候補):
 • standing
 • sitting
 ...（省略）

→ 見やすい、理解しやすい、実用的
```

---

## 影響範囲

### 更新されたファイル
1. `requirements.md` (FR-009, 4.4)
2. `technical_requirements.md` (ui/preview_panel.py)

### 新規作成されたファイル
- `ISSUE_14_RESOLVED.md` （本ファイル）

### 影響を受ける機能
- FR-009: リアルタイムプレビュー
- UI: プレビューパネル

---

## テスト項目

### 単体テスト
- [ ] `load_wildcard_candidates()`が正しく候補を読み込むことを確認
- [ ] 最大5候補までしか取得しないことを確認
- [ ] ワイルドカードパスが正しくファイルパスに変換されることを確認

### 統合テスト
- [ ] シーンに複数のワイルドカードがある場合、個別に表示されることを確認
- [ ] ワイルドカードが0個の場合、候補表示エリアが非表示になることを確認
- [ ] ワイルドカードが1個の場合、正しく表示されることを確認

### UI/UXテスト
- [ ] ワイルドカード展開候補が見やすく表示されることを確認
- [ ] 候補数が正しく表示されることを確認
- [ ] 「（残りN候補...）」が正しく表示されることを確認
- [ ] スクロール可能で、複数のワイルドカードがある場合でも見やすいことを確認

---

## 補足事項

### なぜ全組み合わせ方式は実用的ではないのか？

**1. 組み合わせ爆発の問題**:
- 数学的に、n個のワイルドカードがある場合、全組み合わせは各候補数の積
- 例: 5個のワイルドカードで各10候補 → 10^5 = 100,000パターン

**2. ユーザーにとっての有用性が低い**:
- 1,200パターン見せられても、ユーザーは読めない
- 実際に使うのは1パターンのみ（Stable Diffusionがランダム選択）
- 全組み合わせを見る必要性がない

**3. UI実装の困難性**:
- 1,200行のリストをスクロール表示するのは非現実的
- 読み込み時間も膨大
- メモリ消費も大きい

### 個別ファイル方式のメリット

**1. 実用性**:
- ユーザーは各ファイルにどんな候補があるかを確認できる
- 「このワイルドカードには何が入っているか」を把握するのに十分

**2. パフォーマンス**:
- 計算量がO(n)（線形）
- 表示も高速
- メモリ消費も少ない

**3. 拡張性**:
- 将来的に「候補をクリックして固定テキストに変換」などの機能追加が容易
- 各候補に詳細情報（日本語ラベル等）を表示することも可能

### 将来的な拡張案

**Phase 2以降で検討可能な機能**:

**1. 候補のクリック機能**:
```
【ワイルドカード展開候補】
posing/arm (10候補):
 • arms crossed        [固定化]  ← クリックでワイルドカードを固定テキストに変換
 • arms up             [固定化]
 ...
```

**2. 候補の絞り込み検索**:
```
【ワイルドカード展開候補】
🔍 [検索...] ← 候補内を検索
posing/arm (10候補 → 3候補):
 • arms crossed
 • arms behind back
 ...（"arms"でフィルタ）
```

**3. プレビュー実行**:
```
【ワイルドカード展開候補】
posing/arm (10候補):
 • arms crossed        [プレビュー]  ← クリックで実際の展開例を表示
 ...
```

ただし、**Phase 1では個別ファイル表示のみ**とし、上記は実装しない。

---

## 結論

問題14は**個別ファイルごとの候補表示**で解決した。

**キーポイント**:
- ✅ 全組み合わせではなく、個別ファイルごとに候補を表示
- ✅ 各ファイル最大5候補まで表示、残りは「（残りN候補...）」
- ✅ 計算量がO(n)に削減（組み合わせ爆発を回避）
- ✅ UI実装が容易で、ユーザーにとって実用的

**パフォーマンス改善効果**:
- 計算量: O(n!) → O(n)
- 表示候補数: 1,200パターン → 33候補（約1/36に削減）
- メモリ消費: 膨大 → 軽微

**次のステップ**:
- 問題8（ファイル監視の照合ロジック改善）はオプションなので、Phase 2以降に延期
- 低優先問題（15～25）の確認と対応判断へ進む

---

**承認日**: 2025-10-12
**承認者**: ユーザー
