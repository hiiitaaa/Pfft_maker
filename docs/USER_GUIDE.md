# Pfft_maker ユーザーガイド

バージョン: 1.0
最終更新: 2025-10-14
対象: Pfft_makerを使用するすべてのユーザー

---

## 📖 目次

1. [概要](#概要)
2. [初回起動フロー](#初回起動フロー)
3. [基本ワークフロー](#基本ワークフロー)
4. [30シーン作成フロー](#30シーン作成フロー)
5. [テンプレート機能](#テンプレート機能)
6. [自作プロンプトライブラリ](#自作プロンプトライブラリ)
7. [プロンプト出力とStable Diffusion連携](#プロンプト出力とstable-diffusion連携)
8. [効率化テクニック](#効率化テクニック)
9. [トラブルシューティング](#トラブルシューティング)

---

## 概要

Pfft_makerは、Stable Diffusion WebUIの「Prompts from file or textbox」機能を効率的に使用するためのプロンプト管理ツールです。

### 主な特徴

- **10,942プロンプトを一元管理**: ワイルドカードファイルを読み込み、日本語ラベルで検索
- **3カラムUI**: 探す→組み立てる→確認の直感的なレイアウト
- **30シーン管理**: CG集制作に最適化されたシーン管理機能
- **テンプレート機能**: よく使うプロジェクト構成を保存・再利用
- **AI連携**: Claude APIによる自動ラベル生成（オプション）

### 全体フロー図

```
┌─────────────┐
│ 起動        │
│ ライブラリ  │
│ 読み込み    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│ プロジェクト準備                │
│ • 新規作成                      │
│ • テンプレートから作成          │
│ • 既存プロジェクトを開く        │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ シーン作成（最大30回）          │
│  ┌──────────────────────────┐  │
│  │ 探す → 挿入 → 確認       │  │
│  │ ↓                        │  │
│  │ 次のシーンへ             │  │
│  └──────────────────────────┘  │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ 保存・出力                      │
│ • プロジェクト保存              │
│ • テンプレート保存              │
│ • プロンプト出力                │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ Stable Diffusion WebUI          │
│ → 画像生成                      │
└─────────────────────────────────┘
```

---

## 初回起動フロー

### STEP 1: アプリケーション起動

```bash
# Windowsバッチファイルで起動
run_app.bat

# または直接実行
python run.py
```

**起動時の自動処理:**
- ログシステムの初期化
- 設定ファイルの読み込み
- ワイルドカードファイルの更新チェック
- 新規プロジェクトの自動作成

### STEP 2: ライブラリ読み込み

左パネルの「ライブラリを読み込み」ボタンをクリックします。

**処理内容:**
1. `E:\EasyReforge\Model\wildcards\` からファイルを読み込み
2. 4種類のワイルドカード形式を自動認識
3. 10,942プロンプトをインデックス化（約1秒）
4. カテゴリ別に整理して表示

**読み込まれるカテゴリ例:**
- 📂 行為 (105件)
- 📂 背景 (62件)
- 📂 キャラ (4件)
- 📂 ポージング (25件)
- 📂 アングル (15件)
- 📂 自作 (12件)

### STEP 3: 更新通知の確認（必要時）

ワイルドカードファイルに更新があると、画面上部に通知バナーが表示されます。

```
┌────────────────────────────────────────┐
│ ℹ 新しいワイルドカードがあります      │
│                                        │
│ 更新: 3ファイル                        │
│ 追加: 2ファイル                        │
│ 削除: 1ファイル                        │
│                                        │
│ [詳細を表示] [今すぐ更新] [後で]      │
└────────────────────────────────────────┘
```

**操作:**
- **[今すぐ更新]**: ライブラリを同期（ユーザーラベルは保持）
- **[後で]**: 通知を閉じる（次回起動時に再表示）

---

## 基本ワークフロー

### 3カラムレイアウト

```
┌────────────┐  ┌─────────────┐  ┌─────────────┐
│ 左パネル   │  │ 中央パネル  │  │ 右パネル    │
│ ライブラリ │→ │ シーン編集  │→ │ プレビュー  │
│  (600px)   │  │  (750px)    │  │  (550px)    │
└────────────┘  └─────────────┘  └─────────────┘
  探す・選択      組み立て          確認・出力
```

---

### 左パネル：プロンプトを探す

#### カテゴリから探す

```
┌─ ライブラリ ─────────────┐
│ 📂 カテゴリ一覧          │
│                          │
│ 📂 行為 (105)      [→]  │ ← クリック
│ 📂 背景 (62)       [→]  │
│ 📂 キャラ (4)      [→]  │
└──────────────────────────┘
```

**操作:**
1. カテゴリをクリック → ファイル一覧を表示
2. ファイルをクリック → プロンプト一覧を展開

#### 検索機能

```
🔍 [検索バー]
```

**検索対象:**
- 日本語ラベル（`label_ja`）
- 英語ラベル（`label_en`）
- プロンプト本文（`prompt`）
- タグ（`tags`）
- ファイル名（`source_file`）

**検索例:**
| キーワード | 結果 |
|-----------|------|
| `教室` | 背景/学校.txt → "教室" のプロンプト |
| `座る` | posing/sitting.txt → 座りポーズ候補 |
| `メイド` | キャラ/MAID.txt → メイドキャラ |
| `恥ずかし` | 表情/embarrassed.txt → 恥ずかしい表情 |

**リアルタイム検索:**
- 入力後300ms待機してから検索実行（デバウンス処理）
- 大文字小文字を区別しない

#### プロンプト表示形式

```
┌─ ライブラリ：行為 ──────────────┐
│ ◀ カテゴリ一覧                  │
│ 🔍 [検索...]  📁[tipo_play ▼]   │
│─────────────────────────────────│
│ 📁 tipo_play.txt (90)      [+]  │ ← ファイル全体
│                                 │
│   ├ 1. ({torogao|aheg... [+]   │ ← 個別プロンプト
│   ├ 14. clothed mast... [+]    │
│   ├ 25. deepthroat...   [+]    │
│   └ ...                         │
└─────────────────────────────────┘
```

**視覚的な区別:**
- **ファイル行**: 📁アイコン + 太字 + プロンプト総数
- **プロンプト行**: インデント + 番号 + プレビュー

---

### 中央パネル：シーンを組み立てる

```
┌─ シーン編集 ────────────────┐
│ シーン: [1:保健室 ▼]        │
│                              │
│ [ブロック1] 📌固定           │
│ clothed masturbation         │
│ [編集][削][↑][↓]           │
│                              │
│ [BREAK]                      │
│ [削][↑][↓]                 │
│                              │
│ [ブロック2] 🎲ワイルド       │
│ __posing/arm__               │
│ [編集][削][↑][↓]           │
│                              │
│ [+ブロック] [+BREAK]         │
│ [💾 ライブラリに保存]        │
└──────────────────────────────┘
```

#### プロンプト挿入方法

| 操作 | 結果 | 用途 |
|------|------|------|
| **個別プロンプトをダブルクリック** | 📌 固定テキストとして挿入<br>`clothed masturbation` | 必ずこのプロンプトを使いたい時 |
| **ファイル名の [+] をクリック** | 🎲 ワイルドカードとして挿入<br>`__tipo_play__` | ランダムに選びたい時 |
| **[+BREAK] ボタン** | BREAK区切りを追加 | プロンプトブロックを分割 |

#### ブロック編集操作

**並び替え:**
- **[↑] ボタン**: ブロックを上に移動
- **[↓] ボタン**: ブロックを下に移動
- **ドラッグ&ドロップ**: マウスで直接移動

**編集・削除:**
- **[編集] ボタン**: ブロック内容を編集
- **[削] ボタン**: ブロックを削除
- **右クリックメニュー**: 複製・移動・削除

#### BREAKの役割

**BREAKとは:**
- Stable Diffusionの75トークンチャンク境界を強制
- 前のプロンプトの文脈の影響を区切る

**使用例:**
```
キャラ設定, BREAK, 表情・ポーズ, BREAK, 背景・環境, BREAK, 品質タグ
```

**バリデーションルール:**
- ❌ 連続BREAK不可（`BREAK, BREAK`）
- ✅ 最初にBREAK可
- ✅ 最後にBREAK可

---

### 右パネル：プレビューで確認

```
┌─ プレビュー ────────────────┐
│ 【現在編集中のシーン】       │
│ clothed masturbation,        │
│ BREAK,                       │
│ __posing/arm__,              │
│ BREAK,                       │
│ masterpiece, best quality    │
│                              │
│ 文字数: 145 / ~500           │
│ [コピー] [このシーンを出力]  │
│                              │
│ ─────────────────────────   │
│ 【ワイルドカード展開候補】   │
│ posing/arm (10候補):         │
│  • arms crossed              │
│  • arms up                   │
│  • arms behind back          │
│  （残り7候補...）            │
│                              │
│ ─────────────────────────   │
│ 【全シーン一覧】(30シーン)   │
│  1. clothed mast... ✓        │
│  2. deepthroat... ✓          │
│  3. exhibitionism... ★       │
│  ...                         │
│                              │
│ 完成: 2/30シーン             │
└──────────────────────────────┘
```

#### プレビュー機能

**最終プロンプト表示:**
- カンマ区切りで1行表示
- BREAK処理済み
- ワイルドカード形式（`__filename__`）はそのまま

**ワイルドカード展開候補:**
- 各ファイルの候補を最大5個表示
- 「残りN候補...」で省略表示
- 全組み合わせは表示しない（膨大になるため）

**シーン一覧:**
- ✓: 完成済みシーン
- ★: 現在編集中のシーン
- 空白: 未完成シーン

---

## 30シーン作成フロー

### シーン管理の基本

```
シーン1: 保健室での診察
  ↓ Ctrl+→
シーン2: 教室での授業
  ↓ Ctrl+→
シーン3: 屋上での休憩
  ↓
...
  ↓
シーン30: エンディング
```

### シーン切り替え方法

| 操作 | 機能 |
|------|------|
| **Ctrl + →** | 次のシーンへ移動 |
| **Ctrl + ←** | 前のシーンへ移動 |
| **Ctrl + G** | シーン番号指定ジャンプ |
| **タブクリック** | 下部のシーン一覧タブから選択 |

### 完成シーンの管理

**手動マーク方式:**
```
[シーン: 1:保健室 ▼] [☑ 完成]  ← チェックする
```

**重要:**
- ☑ チェックされたシーンのみが出力対象
- プロンプトの内容や量に関わらず、ユーザーの判断で決定

### 効率的なシーン作成の流れ

```
1. シーン名を入力
   [1:保健室 ▼] → "保健室での診察"

2. プロンプト挿入
   - 行為: "clothed masturbation"
   - BREAK追加
   - 背景: "__背景/学校__"
   - BREAK追加
   - ポーズ: "__posing/sitting__"
   - BREAK追加
   - 品質: "masterpiece, best quality"

3. プレビュー確認
   - 文字数チェック (~500文字推奨)
   - ワイルドカード候補確認

4. [☑ 完成] チェック

5. Ctrl+→ で次のシーンへ
```

---

## テンプレート機能

### テンプレートとは

プロジェクト構成（シーン数・ブロック構造）を保存し、再利用できる機能です。

### テンプレートの種類

#### 1. 構成テンプレート（プレースホルダー方式）

**保存内容:**
- ✅ シーン数（例: 30シーン）
- ✅ ブロック構造（各シーンのブロック数とタイプ）
- ✅ 共通プロンプト設定
- ❌ プロンプト内容（空のまま）

**用途:**
- 毎回異なる内容のプロジェクトを作る時
- プロジェクトの構造だけを統一したい時

**適用後:**
```
シーン1:
  [空の固定ブロック]    ← 自分で埋める
  [BREAK]
  [空のワイルドブロック] ← 自分で埋める
  [BREAK]
  [空の固定ブロック]    ← 自分で埋める
```

#### 2. 完全テンプレート（コピー方式）

**保存内容:**
- ✅ シーン数
- ✅ ブロック構造
- ✅ 共通プロンプト設定
- ✅ プロンプト内容（すべて）

**用途:**
- 似たプロジェクトを量産する時
- ベースとなるプロンプトセットを再利用したい時

**適用後:**
```
シーン1:
  [clothed masturbation]  ← そのまま使える
  [BREAK]
  [__posing/arm__]        ← そのまま使える
  [BREAK]
  [masterpiece, best quality]
```

### テンプレート保存の流れ

```
1. メニュー → ファイル → テンプレートとして保存
   ↓
2. テンプレート保存ダイアログ
   ┌─────────────────────────┐
   │ テンプレート名:          │
   │ [学園メイド基本構成]     │
   │                          │
   │ タイプ:                  │
   │ ◉ 構成テンプレート       │
   │ ○ 完全テンプレート       │
   │                          │
   │ 説明:                    │
   │ [30シーン構成、品質統一] │
   │                          │
   │ [キャンセル] [保存]      │
   └─────────────────────────┘
   ↓
3. [保存] ボタンをクリック
   ↓
4. data/templates.json に保存完了
```

### テンプレートから作成

```
1. メニュー → ファイル → テンプレートから作成
   ↓
2. テンプレート選択ダイアログ
   ┌──────────────────────────┐
   │ 利用可能なテンプレート:  │
   │ ┌────────────────────────┐│
   │ │✨ 学園メイド基本構成   ││ ← 選択
   │ │  (構成テンプレート)    ││
   │ │  30シーン、10回使用    ││
   │ │                        ││
   │ │✨ CG集標準構成         ││
   │ │  (完全テンプレート)    ││
   │ │  20シーン、5回使用     ││
   │ └────────────────────────┘│
   │                          │
   │ プロジェクト名:          │
   │ [新規CG集プロジェクト]   │
   │                          │
   │ [編集] [削除]            │
   │                          │
   │ [キャンセル] [作成]      │
   └──────────────────────────┘
   ↓
3. [作成] ボタンをクリック
   ↓
4. 30シーンの骨組みが自動生成！
```

### テンプレート管理

**削除:**
1. テンプレート選択ダイアログで削除したいテンプレートを選択
2. [削除] ボタンをクリック
3. 確認ダイアログで [はい] を選択

**使用履歴:**
- 使用回数が自動記録される
- 最終使用日時が表示される

---

## 自作プロンプトライブラリ

### 概要

シーン編集中に作成したプロンプトを保存し、再利用できる機能です。

### プロンプト保存の流れ

```
1. シーン編集パネルでブロックを選択
   ↓
2. [💾 ライブラリに保存] ボタンをクリック
   ↓
3. 保存ダイアログ
   ┌─────────────────────────┐
   │ 日本語ラベル:            │
   │ [服の上から愛撫]         │
   │                          │
   │ カテゴリ:                │
   │ [行為 ▼]                 │
   │                          │
   │ タグ（自動生成）:        │
   │ [愛撫,服装付き,crotch... │
   │                          │
   │ [キャンセル] [保存]      │
   └─────────────────────────┘
   ↓
4. [保存] ボタンをクリック
   ↓
5. ライブラリの「自作」カテゴリに追加
```

### 保存されたプロンプトの使用

```
左パネル → 📂 自作 カテゴリ
   ↓
✨ 服の上から愛撫 [+]  ← ダブルクリック
   ↓
シーンに挿入！
```

### 使用履歴の記録

- 使用回数が自動記録
- 最終使用日時が記録
- よく使うプロンプトが分かる

---

## プロンプト出力とStable Diffusion連携

### プロンプト出力の流れ

```
1. メニュー → ファイル → プロンプト出力 (Ctrl+E)
   ↓
2. 出力設定ダイアログ
   ┌─────────────────────────┐
   │ 出力対象: 全30シーン     │
   │                          │
   │ 出力先:                  │
   │ ◉ ファイル               │
   │   ファイル名:            │
   │   [学園メイド_prompts.txt]│
   │   保存先:                │
   │   [E:\works\学園メイド\] │
   │   [参照...]              │
   │                          │
   │ ○ クリップボード         │
   │                          │
   │ オプション:              │
   │ ☑ 完成済みシーンのみ    │
   │ ☐ シーン番号をコメント  │
   │                          │
   │ [キャンセル] [出力]     │
   └─────────────────────────┘
   ↓
3. [出力] ボタンをクリック
   ↓
4. テキストファイル生成
```

### 出力形式

**Prompts from file形式:**
- 1行 = 1シーン = 1枚の画像生成
- カンマ区切り
- BREAK処理済み

**出力例:**
```
clothed masturbation, school infirmary, BREAK, __posing/arm__, BREAK, masterpiece, best quality
deepthroat, classroom interior, BREAK, __posing/leg__, BREAK, best quality
exhibitionism, school rooftop, BREAK, standing, BREAK, amazing quality
```

### Stable Diffusion WebUI連携

```
1. Stable Diffusion WebUI を起動
   ↓
2. Scripts → 「Prompts from file or textbox」を選択
   ↓
3. [参照] ボタンをクリック
   ↓
4. 出力したprompts.txtを選択
   ↓
5. [Generate] ボタンをクリック
   ↓
6. 30枚の画像が自動生成！
```

**ワイルドカードの展開:**
- Dynamic Prompts拡張が自動的にワイルドカードを展開
- `__posing/arm__` → ファイル内からランダムに1つ選択
- 毎回異なるバリエーションが生成される

---

## 効率化テクニック

### 1. 共通プロンプト設定の活用

```
メニュー → ツール → 設定
   ↓
共通プロンプトタブ
   ↓
品質タグ: [masterpiece, best quality, ...]
LoRA: [<lora:futoshi_v1:0.7>]
☑ 新規シーン作成時に自動挿入
   ↓
新規シーン作成時に自動で末尾に追加！
```

**メリット:**
- 毎回入力する手間を削減
- プロジェクト全体で品質を統一

### 2. 検索の高度な活用

**複数キーワード検索:**
```
🔍 メイド 教室  ← スペース区切りでAND検索
```

**カテゴリフィルタ併用:**
```
📁 [背景 ▼] + 🔍 学校  ← より絞り込み
```

### 3. キーボードショートカットの活用

| ショートカット | 機能 | 使用場面 |
|--------------|------|----------|
| `Ctrl+S` | 保存 | こまめな保存 |
| `Ctrl+E` | プロンプト出力 | 完成後の出力 |
| `Ctrl+→` | 次のシーン | 高速シーン移動 |
| `Ctrl+←` | 前のシーン | シーン確認 |
| `Ctrl+N` | 新規プロジェクト | プロジェクト開始 |

### 4. プレビューパネルの活用

**文字数チェック:**
- 推奨: ~500文字
- 長すぎる場合: プロンプトを分割・削減

**ワイルドカード候補確認:**
- 意図しないプロンプトが含まれていないか確認
- 候補が少ない場合: ファイル全体（ワイルドカード）として挿入

### 5. テンプレートの効率的な使い方

**プロジェクトタイプ別のテンプレート:**
```
- 学園メイド基本構成（30シーン）
- 短編CG集構成（10シーン）
- LoRA比較用構成（5シーン×6キャラ）
```

**構成テンプレートの活用:**
- ベースの構造は共通
- 内容は毎回変える
- 一貫性を保ちつつ柔軟に対応

---

## トラブルシューティング

### ライブラリが読み込めない

**症状:**
- 「ライブラリを読み込み」ボタンをクリックしてもカテゴリが表示されない

**原因と対策:**

1. **ワイルドカードディレクトリが存在しない**
   ```
   対策: 設定でワイルドカードディレクトリのパスを確認
   デフォルト: E:\EasyReforge\Model\wildcards\
   ```

2. **ファイル形式が対応していない**
   ```
   対策: .txtファイルであることを確認
   対応形式: パターン1-4（詳細はrequirements.md参照）
   ```

3. **エンコーディングエラー**
   ```
   対策: UTF-8で保存されているか確認
   BOM付き/なし両対応
   ```

### プロンプトが正しく出力されない

**症状:**
- 出力したプロンプトファイルが期待と異なる

**原因と対策:**

1. **連続カンマが含まれる**
   ```
   原因: ブロックが空の場合に発生
   対策: プレビューパネルで確認し、空のブロックを削除
   ```

2. **BREAKの位置が不適切**
   ```
   原因: 連続BREAKがある
   対策: バリデーションエラーを確認し、修正
   ```

3. **ワイルドカード形式が正しくない**
   ```
   正しい: __posing/arm__
   誤り: __posing\arm__（バックスラッシュ）
   ```

### シーンが保存されない

**症状:**
- シーンを編集したが、プロジェクトに反映されない

**原因と対策:**

1. **自動保存が失敗している**
   ```
   対策: 手動保存（Ctrl+S）を実行
   ログファイルを確認: logs/pfft_maker_YYYYMMDD.log
   ```

2. **ネットワークドライブに保存している**
   ```
   対策: ローカルドライブに保存
   通知バナーのエラーメッセージを確認
   ```

### テンプレートが作成できない

**症状:**
- テンプレート保存ダイアログで [保存] が押せない

**原因と対策:**

1. **テンプレート名が空**
   ```
   対策: テンプレート名を入力
   ```

2. **シーンが空**
   ```
   対策: 最低1シーンは作成してから保存
   ```

### アプリが起動しない

**症状:**
- run_app.batを実行してもウィンドウが表示されない

**原因と対策:**

1. **Python環境が正しくない**
   ```
   対策: Python 3.11以上がインストールされているか確認
   コマンド: python --version
   ```

2. **依存関係がインストールされていない**
   ```
   対策: pip install -r requirements.txt を実行
   ```

3. **ログを確認**
   ```
   場所: logs/pfft_maker_YYYYMMDD.log
   エラーメッセージを確認して対処
   ```

---

## 付録

### データファイルの場所

```
Pfft_maker/
├── data/
│   ├── prompts_library.csv   # ライブラリデータ
│   ├── settings.json          # 設定ファイル
│   ├── templates.json         # テンプレート
│   └── custom_prompts.json    # 自作プロンプト
├── wildcards/                 # ワイルドカードファイル
└── logs/                      # ログファイル
```

### プロジェクトファイルの構造

**ファイル形式:** JSON（`.pfft`）

```json
{
  "project_info": {
    "name": "学園メイドCG集",
    "created_date": "2025-10-14T10:00:00",
    "last_modified": "2025-10-14T15:30:00",
    "description": "保健室を舞台にしたメイド物"
  },
  "scenes": [
    {
      "scene_id": 1,
      "scene_name": "保健室での診察",
      "is_completed": true,
      "blocks": [...]
    }
  ],
  "common_prompts": [...],
  "metadata": {...}
}
```

### よく使うフォルダパス

| 用途 | デフォルトパス |
|------|--------------|
| ワイルドカード | `E:\EasyReforge\Model\wildcards\` |
| プロジェクト保存 | ユーザー指定 |
| プロンプト出力 | ユーザー指定 |
| ログファイル | `E:\tool\Pfft_maker\logs\` |
| データファイル | `E:\tool\Pfft_maker\data\` |

---

## 関連ドキュメント

- [チュートリアル（初心者向け）](TUTORIAL.md)
- [機能要件定義書](../requirements.md)
- [技術要件定義書](../technical_requirements.md)
- [開発ガイド](archive/CLAUDE.md)

---

**ご不明な点がございましたら、Issue報告をお願いします:**
https://github.com/anthropics/pfft_maker/issues
