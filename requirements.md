# Pfft_maker 機能要件定義書

バージョン: 1.1
最終更新日: 2025-01-15
ステータス: 確定版（実環境調査反映）

---

## 1. プロジェクト概要

### 1.1 ツール名
**Pfft_maker**（プロンプト管理・生成ツール）

### 1.2 目的
Stable Diffusion WebUIの「Prompts from file or textbox」機能を効率的に使用するためのプロンプト管理・生成ツール。CG集制作におけるプロンプト管理を効率化し、複数シーンのプロンプトを体系的に管理・出力する。

### 1.3 対象ユーザー
- Stable Diffusion WebUIを使用するCG集制作者
- ワイルドカードファイルを活用する画像生成ユーザー
- 複数シーン（10～30シーン）のプロンプトを管理する必要があるユーザー

### 1.4 実行環境
- Windows 10/11
- 単一exe形式で配布（Python環境不要）
- FULLHD（1920×1080）解像度推奨

---

## 2. 解決する課題

### 2.1 現状の問題点
1. **プロンプト探索の非効率性**
   - 複数のワイルドカードファイルを開いて目的のプロンプトを探す手間
   - ファイルが多く、どこに何があるか把握困難

2. **並べ替え作業の煩雑さ**
   - ストーリー順に手動でコピペして組み立てる作業
   - 30シーン分のプロンプトを手作業で管理

3. **記録・管理の欠如**
   - どのプロンプトを使ったか記録がなく、再度探す必要がある
   - 過去のプロジェクトを参照できない

4. **日本語ラベルの混入**
   - `| 教室 |` など自分用メモが本番プロンプトに含まれる
   - 手動で削除する必要がある

### 2.2 解決策
- 全ワイルドカードファイルを一元管理
- 日本語ラベル付きライブラリで検索・選択を容易化
- シーンごとにプロンプトを構築・管理
- 出力時に自動でクリーンなプロンプトを生成

---

## 3. 機能要件

### 3.1 プロンプトソース管理

#### FR-001: ワイルドカードファイル読み込み
**概要**: 指定ディレクトリ配下の全ワイルドカードファイルを読み込み、Pfft_maker管理ディレクトリにコピー・クリーン化してインデックス化する

**入力**:
- 元ディレクトリパス（デフォルト: `E:\EasyReforge\Model\wildcards\`）

**処理**:
1. **初回起動時**: 元ディレクトリから `E:\tool\Pfft_maker\wildcards\` に全ファイルをコピー
2. **エンコーディング自動検出**（フォールバック付き）:
   - 優先エンコーディング試行順序: `utf-8-sig` → `utf-8` → `shift_jis` → `cp932`
   - すべて失敗した場合: chardetライブラリで検出
   - デコードエラー時: `errors='replace'`で文字を置換して読み込み
   - 理由: 短いファイルや日本語ファイルでchardetの誤判定を防ぐため
3. **ファイルクリーン化**:
   - BOM（`\uFEFF`）除去
   - 番号削除（`14→` の部分を削除）
   - 空行削除
   - UTF-8で保存
4. **パース処理** (元ファイルから情報抽出):
   - **パターン1**: `14→| 教室 | classroom interior...` (番号+テーブル型)
   - **パターン2**: `| 教室 | classroom interior...` (テーブル型)
   - **パターン3**: `14→clothed masturbation` (番号付き型) ← **実環境で確認**
   - **パターン4**: `clothed masturbation` (シンプル型)
5. CSV形式でライブラリに保存

**ディレクトリ構造**:
```
E:\EasyReforge\Model\wildcards\     ← 元ディレクトリ（読み取り専用）
E:\tool\Pfft_maker\wildcards\       ← Pfft_maker管理（クリーン化済み）
E:\tool\Pfft_maker\data\
  ├── prompts_library.csv           ← パース結果
  └── labels_metadata.json          ← ユーザー設定
```

**出力**:
- `wildcards/` (クリーン化済みファイル群)
- `prompts_library.csv` (内部管理用)
- `labels_metadata.json` (ユーザー設定)

**データ構造**:
```csv
id,source_file,original_line_number,original_number,label_ja,label_en,prompt,category,tags,created_date,last_used,label_source
tipo_play_14,tipo_play.txt,14,14,服着たままオナニー,clothed masturbation,clothed masturbation,行為,"clothed,masturbation",2025-01-15,,auto_extract
bg_school_9,背景/学校.txt,9,9,教室,classroom,"classroom interior, desks in rows...",背景,"school,classroom",2025-01-15,,auto_extract
```

**カラム説明**:
- `id`: 一意識別子（`ファイル名_連番`）
- `source_file`: 元ファイルパス（相対パス）
- `original_line_number`: 元ファイルの行番号（**参考情報**、元ファイル変更時は無効）
- `original_number`: 元の番号（`14→`の14、**プロンプト照合に使用**）
- `label_ja`: 日本語ラベル
- `label_en`: 英語ラベル
- `prompt`: プロンプト本体
- `category`: カテゴリ
- `tags`: タグ（カンマ区切り）
- `created_date`: 作成日
- `last_used`: 最終使用日
- `label_source`: ラベル取得方法（`auto_extract` / `ai_generated` / `manual`）

**重要な注意事項**:
- `original_line_number`は**参考情報**であり、元ファイルが変更されると無効になります
- プロンプト照合には`original_number`（`14→`の番号）や内容の類似度を使用してください
- `original_number`がnullの場合（シンプル型）は、プロンプト内容の類似度で照合します

---

#### FR-002: カテゴリ自動分類
**概要**: ファイルのディレクトリ構造から自動的にカテゴリを推測し、分類する

**自動分類ルール**:
- `キャラ/SAYA.txt` → カテゴリ「キャラ」
- `背景/学校.txt` → カテゴリ「背景」
- `posing/arm.txt` → カテゴリ「ポージング」
- `angle/camera.txt` → カテゴリ「アングル」
- その他 → ファイル名から推測 or 「その他」

**カスタムカテゴリ設定**:
```json
{
  "categories": [
    {
      "name": "行為",
      "files": ["tipo_play.txt", "tipo_1girl.txt"],
      "color": "#ff6b6b"
    },
    {
      "name": "背景",
      "files": ["背景/学校.txt", "背景/ビーチ.txt"],
      "color": "#4ecdc4"
    }
  ]
}
```

---

#### FR-003: 日本語ラベル管理
**概要**: プロンプトに日本語ラベルを付与し、検索・管理を容易にする

**ラベル取得方法**:
1. **自動抽出**:
   - テーブル型: `| 教室 |` → `label_ja: "教室"`
   - 番号付き型: プロンプトの先頭部分を `label_en` に設定
2. **AI自動生成** (オプション):
   - Claude API / LM Studio でラベル生成
3. **手動入力**:
   - UI上でユーザーが編集可能

**ラベル管理ファイル** (`labels_metadata.json`):
```json
{
  "tipo_play_14": {
    "label_ja": "服着たままオナニー",
    "label_en": "clothed masturbation",
    "tags": ["服", "オナニー", "clothed", "masturbation"],
    "category": "行為",
    "notes": "",
    "user_modified": true,
    "last_modified": "2025-01-15T14:30:00"
  },
  "bg_school_12": {
    "label_ja": "保健室",
    "label_en": "school infirmary",
    "tags": ["学校", "保健室", "school", "infirmary"],
    "category": "背景",
    "notes": "",
    "user_modified": true,
    "last_modified": "2025-01-15T14:35:00"
  }
}
```

**説明**:
- ユーザーが手動で編集したメタデータのみ保存
- ファイル更新時もIDで紐付けて保持される

---

#### FR-004: 自作プロンプトライブラリ
**概要**: シーン編集中に作成したプロンプトをライブラリに保存・再利用する

**機能**:
- プロンプトの保存（日本語ラベル、カテゴリ、タグを付与）
- 使用履歴の記録
- 検索・フィルタリング

**データ構造**:
```json
{
  "custom_prompts": [
    {
      "id": "custom_001",
      "prompt": "crotch_grab,fondling,over_clothes,fingering,embarrassed",
      "label": "服の上から愛撫",
      "category": "行為",
      "tags": ["愛撫", "服装付き", "恥ずかしがり", "crotch_grab", "fondling"],
      "created_date": "2025-01-15",
      "usage_count": 3,
      "used_in_projects": ["学園メイドCG集", "OL物語"]
    }
  ]
}
```

---

#### FR-005: ファイル更新チェック・手動同期
**概要**: 元ディレクトリのワイルドカードファイル変更を検知し、手動で同期する

**更新チェック方式**:
- 起動時に自動チェック（更新日時・ファイル数を比較）
- 手動更新（[🔄更新]ボタン）

**起動時の更新検知**:
1. 元ディレクトリ（`E:\EasyReforge\Model\wildcards\`）をスキャン
2. ローカルディレクトリと比較
3. 変更がある場合、通知バナー表示:
   ```
   ℹ 新しいワイルドカードがあります

   更新: 3ファイル
   追加: 2ファイル
   削除: 1ファイル

   [詳細を表示] [今すぐ更新] [後で]
   ```

**手動更新処理** ([今すぐ更新] / [🔄更新]ボタン):
1. 変更されたファイルを元ディレクトリからコピー
2. ファイルクリーン化（番号削除等）
3. CSV再構築
4. `labels_metadata.json`とマージ（ユーザー設定を保持）
5. 完了通知: "✅ 5個のファイルを更新しました"

**ユーザーラベル保持ロジック**:
- `original_number`で照合（`14→` の14）
- プロンプト内容の類似度90%以上で照合
- 一致するものはIDを維持、ラベル・タグを保持

---

### 3.2 シーン編集機能

#### FR-006: プロンプトブロック管理
**概要**: シーン内のプロンプトをブロック単位で管理する

**ブロックタイプ**:
1. **固定テキストブロック** (📌)
   - 内容: 任意のテキスト
   - 動作: 常にこのプロンプトが使用される
   - 挿入方法: ライブラリから個別プロンプトを選択

2. **ワイルドカードブロック** (🎲)
   - 内容: `__ファイル名__` または `__フォルダ/ファイル名__` 形式
   - 例: `__tipo_play__`, `__posing/arm__`, `__キャラ/SAYA__`
   - 動作: Stable Diffusion実行時にランダム展開
   - 挿入方法: ライブラリからファイル全体を選択

3. **BREAKブロック**
   - 内容: `BREAK`
   - 動作: プロンプトブロックの区切り
   - 挿入方法: [+BREAK]ボタン

**バリデーションルール**:
- ❌ 連続BREAK不可（BREAK → BREAK）
- ✅ 最初にBREAK可
- ✅ 最後にBREAK可

---

#### FR-007: プロンプト挿入
**概要**: ライブラリからプロンプトをシーンに挿入する

**挿入方法**:
1. **ファイル名の [+] をクリック**:
   - ワイルドカード形式で挿入
   - 例: `__tipo_play__`, `__posing/arm__`, `__スクリプト/nsfw_sex_spresdlegs/aftersex__`
   - Stable Diffusion実行時にDynamic Prompts拡張がランダム展開

2. **個別プロンプトの [+] をクリック**:
   - 固定テキストとして挿入 (例: `clothed masturbation`)
   - 常にこのプロンプトが使用される

3. **ダブルクリック**:
   - プロンプトをダブルクリック → 固定テキストとして即挿入

4. **チェックボックス選択**:
   - 複数チェック → [挿入]ボタン
   - 選択した順番でシーンに挿入

**ワイルドカード形式の生成ルール**:
```python
# 例
E:\tool\Pfft_maker\wildcards\tipo_play.txt → __tipo_play__
E:\tool\Pfft_maker\wildcards\play.txt → __play__
E:\tool\Pfft_maker\wildcards\posing\arm.txt → __posing/arm__
E:\tool\Pfft_maker\wildcards\キャラ\SAYA.txt → __キャラ/SAYA__
```
- 拡張子（.txt）は不要
- ルートディレクトリのファイル: `__filename__`
- サブディレクトリのファイル: `__folder/filename__`
- ディレクトリ区切りは `/`（Unixスタイル）

---

#### FR-008: ブロック編集操作
**概要**: シーン内のブロックを編集・並び替えする

**操作**:
- **並び替え**: [↑][↓]ボタンまたはドラッグ&ドロップ
- **削除**: [削除]ボタン
- **複製**: 右クリックメニュー → [複製]
- **インライン編集**: ブロックをダブルクリック → 直接編集
- **複数選択**: Ctrlキー押しながらクリック → まとめて移動/削除

**右クリックメニュー**:
```
┌─────────────────────┐
│ ブロックを編集      │
│ ─────────────────── │
│ 複製                │
│ 削除                │
│ ─────────────────── │
│ 上に移動            │
│ 下に移動            │
│ ─────────────────── │
│ ライブラリに保存    │
└─────────────────────┘
```

---

#### FR-009: リアルタイムプレビュー
**概要**: 編集中のシーンの最終プロンプトをリアルタイム表示する

**表示内容**:
- 最終プロンプト（1行形式）
- ワイルドカード展開候補（個別ファイルのみ表示）
- 文字数カウント（推奨: ~500文字）

**ワイルドカード展開候補の表示方式**:
- **個別ファイルごとに候補を表示**（全組み合わせは表示しない）
- 理由: 複数ワイルドカードの全組み合わせは膨大になるため（例: 10×8×15 = 1,200パターン）
- 表示例:
  ```
  【ワイルドカード展開候補】
  posing/arm (10候補):
   • arms crossed
   • arms up
   • arms behind back
   • arms at sides
   • arms behind head
   （残り5候補...）

  posing/leg (8候補):
   • standing
   • sitting
   • kneeling
   • spread legs
   （残り4候補...）
  ```

**操作**:
- [コピー]: クリップボードにコピー
- [このシーンを出力]: 現在のシーンのみを出力

---

### 3.3 プロジェクト管理

#### FR-010: プロジェクト保存・読み込み
**概要**: CG集単位でプロジェクトを保存・管理する

**ファイル形式**: JSON (`.pfft`)

**プロジェクトデータ構造**:
```json
{
  "project_info": {
    "name": "学園メイドCG集",
    "created_date": "2025-01-15",
    "last_modified": "2025-01-20",
    "description": "保健室を舞台にしたメイド物"
  },
  "scenes": [
    {
      "scene_id": 1,
      "scene_name": "保健室での診察",
      "is_completed": true,
      "created_date": "2025-01-15",
      "blocks": [
        {
          "block_id": 1,
          "type": "fixed_text",
          "content": "clothed masturbation",
          "source": {
            "file": "tipo_play.txt",
            "line_number": 14,
            "label": "服着たままオナニー"
          }
        },
        {
          "block_id": 2,
          "type": "break"
        },
        {
          "block_id": 3,
          "type": "wildcard",
          "content": "__posing/arm__",
          "source": {
            "file": "posing/arm.txt"
          }
        }
      ],
      "final_prompt": "clothed masturbation, BREAK, __posing/arm__, BREAK, ..."
    }
  ],
  "metadata": {
    "total_scenes": 10,
    "output_history": [...]
  }
}
```

**保存方式**:
- **自動保存**: 編集後30秒で自動保存（エラーハンドリング付き）
  - 一時ファイル（`.pfft.tmp`）に保存後、成功したら本番ファイルに上書き
  - 保存失敗時は通知バナー表示、手動保存を推奨
  - ネットワークドライブ、書き込みエラー、ファイルロック等に対応
- **手動保存**: [保存]ボタンで確定保存
- **終了時確認**: 未保存確認ダイアログ表示

**自動保存のエラーハンドリング**:
1. 一時ファイル（`project_name.pfft.tmp`）に保存
2. 保存成功 → 本番ファイル（`project_name.pfft`）に上書き（アトミック操作）
3. 保存失敗 → エラーログ記録 + UI通知バナー表示
4. 通知内容: 「⚠ 自動保存に失敗しました。手動保存を推奨します。」

**エラー通知UI**:
```
┌─────────────────────────────────────────┐
│ ⚠ 自動保存に失敗しました              │
│                                        │
│ 理由: ネットワークドライブへの書き込み│
│       がタイムアウトしました           │
│                                        │
│ [手動保存] [詳細を表示] [閉じる]      │
└─────────────────────────────────────────┘
```

**バックアップ戦略**:
- 手動保存時に自動で世代バックアップ作成
- `.backup/` ディレクトリに保存
- 最大5世代保持、6世代目以降は古いものから削除

```
プロジェクトフォルダ構成:
学園メイドCG集.pfft
学園メイドCG集.pfft.tmp  ← 自動保存用一時ファイル（通常は即削除）
.backup/
  ├ 学園メイドCG集_20250120_1430.pfft
  ├ 学園メイドCG集_20250120_1210.pfft
  └ ...（最大5世代保持）
```

---

#### FR-011: 30シーン管理
**概要**: 1プロジェクトで最大30シーンを管理し、各シーンを個別に編集する

**シーン構成**:
- 1シーン = 1行 = 1枚の画像生成
- シーン番号: 1～30
- シーン名: ユーザーが任意に設定（例: "保健室", "教室", "屋上"）

**シーン切り替え方法**:
1. **タブクリック**: 下部のシーン一覧タブをクリック
2. **キーボードショートカット**:
   - `Ctrl + →`: 次のシーンへ
   - `Ctrl + ←`: 前のシーンへ
   - `Ctrl + G`: シーン番号指定ジャンプ
3. **プレビューから**: プレビューの全シーン一覧でクリック

**完成シーン判定**:
- **手動マーク方式**: ユーザーが明示的にチェックボックスで完成を指定
- UIに`[☑ 完成]`チェックボックスを表示
- チェックされたシーンのみが出力対象となる
- プロンプトの内容や量に関わらず、ユーザーの判断で完成を決定

**UI表示例**:
```
[シーン: 1:保健室 ▼] [☑ 完成]  ← 完成したシーン
[シーン: 2:教室 ▼] [☐ 完成]    ← 調整中のシーン
[シーン: 3:屋上 ▼] [☐ 完成]    ← 未完成のシーン
```

**シーン状態**:
- **完成**: ✓チェック済み（出力対象）
- **未完成**: ☐チェックなし（出力除外）
- **編集中**: ★マーク表示（現在編集中のシーン）

**シーン削除時の動作**:
- **番号付け直し方式**: シーンを削除すると、以降のシーン番号が自動的に詰まる
- **例**:
  ```
  削除前: [1:保健室] [2:教室] [3:屋上] [4:プール]
  シーン3削除
  削除後: [1:保健室] [2:教室] [3:プール]  ← 番号が詰まる
  ```
- **出力履歴の管理**: シーン番号ではなく `scene_name` で履歴を管理することで整合性を保つ
- **メリット**: UI上は常に連番で表示され、ユーザーが混乱しない

**出力履歴の記録形式**:
```json
{
  "output_history": [
    {
      "date": "2025-01-15 14:30",
      "output_file": "学園メイド_prompts.txt",
      "scenes": [
        {"scene_name": "保健室", "prompt_preview": "clothed masturbation..."},
        {"scene_name": "教室", "prompt_preview": "deepthroat..."},
        {"scene_name": "屋上", "prompt_preview": "exhibitionism..."}
      ]
    }
  ]
}
```

---

#### FR-012: 共通プロンプト機能
**概要**: 新規シーン作成時に自動挿入されるプロンプトのテンプレートを設定する

**用途**:
- 品質タグ（`masterpiece, best quality, ...`）
- LoRA（`<lora:xxx:0.7>`）
- スタイル指定（`official_art, anime, ...`）

**設定項目**:
```
品質タグ:
  [masterpiece, best quality... ▼]
  ☑ 新規シーン作成時に末尾に挿入

LoRA:
  [<lora:futoshi_v1:0.7>... ▼]
  ☑ 新規シーン作成時に挿入
  挿入位置: [末尾 ▼]

スタイル指定:
  [official_art, anime... ▼]
  ☑ 新規シーン作成時に挿入
```

**動作仕様**:
- **新規シーン作成時**: 設定された共通プロンプトを自動挿入
- **挿入後の扱い**: 通常のブロックとして扱われ、ユーザーが自由に編集・移動・削除可能
- **既存シーンへの影響**: なし（共通プロンプト設定を変更しても、既存シーンには反映されない）

**シーン編集での表示例**:
```
[ブロック1] 📌固定
clothed masturbation
[編集][削][↑][↓]

[BREAK]

[ブロック2] 🎲ワイルド
__posing/arm__
[編集][削][↑][↓]

[ブロック3] 📌固定  ← 共通プロンプトから挿入（通常ブロックと同じ扱い）
<lora:futoshi_v1:0.7>
[編集][削][↑][↓]

[ブロック4] 📌固定  ← 共通プロンプトから挿入（通常ブロックと同じ扱い）
masterpiece, best quality
[編集][削][↑][↓]
```

**メリット**:
- シーンごとに柔軟にカスタマイズ可能
- 共通プロンプトが不要なシーンでは削除できる
- UIの挙動が一貫（全ブロックが同じ操作可能）

---

#### FR-013: テンプレート機能
**概要**: プロジェクト構成をテンプレートとして保存・再利用する

**テンプレートの種類**:

**1. 構成テンプレート（プレースホルダー方式）**
- **保存内容**:
  - ☑ シーン数（例: 30シーン）
  - ☑ ブロック構造（各シーンのブロック数とタイプ）
  - ☑ 共通プロンプト設定
  - ☐ プロンプト内容（空のまま）
- **用途**: プロジェクトの構造だけを再利用したい場合
- **特徴**: プレースホルダー（空のブロック）として保存され、ユーザーが内容を埋める

**動作例**:
```
テンプレート適用後:
シーン1:
  [空の固定ブロック]    ← ユーザーが埋める
  [BREAK]
  [空のワイルドカードブロック]  ← ユーザーが埋める
  [BREAK]
  [空の固定ブロック]    ← ユーザーが埋める

シーン2:
  [空の固定ブロック]
  ...
```

**2. 完全テンプレート（コピー方式）**
- **保存内容**:
  - ☑ シーン数
  - ☑ ブロック構造
  - ☑ 共通プロンプト設定
  - ☑ プロンプト内容（すべて）
- **用途**: よく使うプロジェクト構成をそのままコピーしたい場合
- **特徴**: プロンプト内容も含めて完全にコピー、すぐに使える

**動作例**:
```
テンプレート適用後:
シーン1:
  [clothed masturbation]  ← そのまま使える
  [BREAK]
  [__posing/arm__]        ← そのまま使える
  [BREAK]
  [masterpiece, best quality]

シーン2:
  [deepthroat]
  ...
```

**テンプレート保存UI**:
```
┌─ テンプレート保存 ─────────────────┐
│ テンプレート名:                    │
│ [学園メイド基本構成______]         │
│                                    │
│ テンプレートタイプ:                │
│ ◉ 構成テンプレート                 │
│   （プロンプト内容は保存しない）   │
│ ○ 完全テンプレート                 │
│   （プロンプト内容も含めて保存）   │
│                                    │
│ 説明（オプション）:                │
│ ┌────────────────────────────────┐ │
│ │30シーン構成、品質タグ統一      │ │
│ └────────────────────────────────┘ │
│                                    │
│          [キャンセル] [保存]       │
└────────────────────────────────────┘
```

**使用例**:
1. 「学園メイド基本構成」テンプレートを作成
2. 新規プロジェクト作成時にテンプレートを選択
3. 構成テンプレート: 空のブロックが並ぶ → ユーザーが埋める
4. 完全テンプレート: 内容も含めてコピー → 微調整のみ

**メリット**:
- 構成テンプレート: 柔軟性が高く、毎回異なる内容のプロジェクトに使える
- 完全テンプレート: 似たプロジェクトを量産する際に効率的

---

### 3.4 検索・フィルタリング

#### FR-014: プロンプト検索
**概要**: ライブラリ内のプロンプトを検索する

**検索方式**: シンプル全文検索（部分一致）

**検索対象**:
- `label_ja`（日本語ラベル）
- `label_en`（英語ラベル）
- `prompt`（プロンプト本文）
- `tags`（タグ）
- `source_file`（ファイル名）

**検索仕様**:
- **リアルタイム**: 入力中に結果更新（デバウンス処理付き）
  - 入力後300ms待機してから検索実行
  - UIの重さを防ぎ、快適な検索体験を提供
- **大文字小文字**: 区別なし
- **複数キーワード**: スペース区切りでAND検索（オプション）

**UI**:
```
🔍 [検索...______] [×]
```

---

#### FR-015: カテゴリフィルタリング
**概要**: カテゴリでプロンプトを絞り込む

**フィルタ項目**:
- 全て
- 行為
- 背景
- キャラ
- ポージング
- アングル
- 自作プロンプト

**UI**:
```
📁 カテゴリ: [全て ▼]
```

---

### 3.5 AI自動生成（オプション）

#### FR-016: ラベル・タグ自動生成
**概要**: AIを使用してプロンプトに日本語ラベル・タグを自動生成する

**動作フロー**:
```
ワイルドカード読み込み
   ↓
【ステップ1: 自動抽出】
├ テーブル型: | 教室 | → label_ja: "教室"
├ 番号付き型: 14→clothed... → label_en: "clothed masturbation"
└ タグ: 単語分割で自動生成（詳細は下記）
   ↓
【ステップ2: AI自動生成（オプション）】
label_ja が空欄のプロンプトに対して
├ Claude API / LM Studio に一括送信
├ 日本語ラベル生成
└ タグ補完
   ↓
【ステップ3: 手動編集】
ユーザーが必要に応じて修正
```

**タグ自動生成の詳細仕様**:

**基本方針**: シンプルな単語分割でタグを生成（AI不要、常時動作）

**生成ロジック**:
1. プロンプト文字列を小文字化
2. カンマ(`,`)、アンダースコア(`_`)、スペース(` `)で分割
3. フィルタリング:
   - 空文字列を除去
   - 1文字の単語を除外（`a`, `i`, `s`など）
   - 英数字以外のみの文字列を除外
4. 重複を削除（順序は保持）
5. 最大10タグまで

**実装例**:
```python
def generate_tags_auto(prompt: str) -> List[str]:
    """自動タグ生成

    Args:
        prompt: "school_infirmary, beds with curtain dividers"

    Returns:
        ["school", "infirmary", "beds", "with", "curtain", "dividers"]
    """
    # 1. 小文字化
    text = prompt.lower()

    # 2. カンマ、アンダースコア、スペースで分割
    words = re.split(r'[,_\s]+', text)

    # 3. フィルタリング
    tags = [w.strip() for w in words
            if w.strip() and len(w.strip()) > 1 and w.strip().isalnum()]

    # 4. 重複削除（順序保持）
    seen = set()
    unique_tags = []
    for tag in tags:
        if tag not in seen:
            seen.add(tag)
            unique_tags.append(tag)

    # 5. 最大10タグ
    return unique_tags[:10]
```

**生成例**:
| プロンプト | 生成されるタグ |
|-----------|--------------|
| `school_infirmary` | `school`, `infirmary` |
| `clothed masturbation` | `clothed`, `masturbation` |
| `classroom interior, desks in rows` | `classroom`, `interior`, `desks`, `in`, `rows` |
| `({torogao\|ahegao}: 1.4)` | `torogao`, `ahegao`, `1`, `4` |

**日本語の扱い**:
- Phase 1では日本語の形態素解析は実装しない
- AI生成（Claude API/LM Studio）で日本語タグを補完することを推奨
- 手動編集で日本語タグを追加可能

**限界と対応策**:
- **限界**: 複雑な表現（括弧、記号）は正確に分割できない
- **対応策**: AI生成またはユーザーの手動編集で補完

**AI設定（3段階フォールバック）**:
1. **Claude API**（優先）: 高精度、要APIキー
2. **LM Studio**（フォールバック）: ローカルLLM、オフライン可能
3. **辞書ベース**（最終手段）: 単語分割のみ、常に有効

**完全オフライン動作**:
- ☐ オンラインAPIを使用しない
- チェック時は LM Studio または 辞書ベースのみ使用

---

#### FR-017: セキュアなAPIキー管理
**概要**: Claude APIキーを安全に保存・管理する

**セキュリティ方式（3層）**:
1. **暗号化**: Fernet（AES128ベース）
2. **マスターキー**: OSキーチェーンに保存（Windows資格情報マネージャー等）
3. **ファイルパーミッション**:
   - Windows: ACL（Access Control List）または隠しファイル化
   - Unix/Linux/Mac: chmod 600

**セキュリティチェックリスト**:
- ✅ APIキーは暗号化保存（Fernet AES128）
- ✅ マスターキーはOSキーチェーン管理
- ✅ ファイル保護:
  - Windows: pywin32でACL設定、フォールバックで隠しファイル化
  - その他OS: chmod 600
- ✅ アプリ終了時にメモリクリア
- ✅ ログにAPIキーを出力しない
- ✅ 設定ファイルは.gitignore
- ✅ UI上ではマスク表示

**UI**:
```
APIキー:
[●●●●●●●●●●●●●●●●●●●●] [表示] [変更]

状態: ✅ 認証成功
使用モデル: [Haiku ▼]

🔒 セキュリティ:
• 暗号化してファイルに保存
• OSが安全に管理
• 他ユーザーからアクセス不可

[接続テスト] [削除]
```

---

### 3.6 出力機能

#### FR-018: プロンプトファイル出力
**概要**: 全シーンのプロンプトを1行1プロンプト形式でファイル出力する

**出力形式**: Prompts from file形式
- 1行 = 1シーン = 1枚の画像生成
- 日本語ラベル自動除去
- クリーンなプロンプトのみ

**BREAK処理ルール**:
- BREAK前: カンマあり（`prompt, BREAK`）
- BREAK後: スペース区切り（`BREAK prompt`）
- 連続カンマ・スペースは自動削除

**出力例**:
```
official_art, __posing/arm__, BREAK __キャラ/SAYA__, sitting, maid costume, BREAK masterpiece, best quality
clothed masturbation, school infirmary, BREAK __posing/leg__, BREAK amazing quality
exhibitionism, school rooftop, BREAK standing, spread legs, BREAK best quality
...
(30行 = Stable Diffusionで30枚生成)
```

**プロンプト構築処理**:
1. ブロックを順番に結合
2. BREAK前のカンマを削除
3. BREAKの前後にスペース挿入
4. 連続カンマ・スペースをクリーンアップ
5. 1行にまとめる

**出力設定**:
```
出力対象: 全30シーン

出力先:
◉ ファイル
  ファイル名: [学園メイド_prompts.txt]
  保存先: [E:\works\学園メイド\___]
          [参照...]

○ クリップボード

オプション:
☑ 完成済みシーンのみ
☐ シーン番号をコメントで追記

     [キャンセル] [出力]
```

**「完成済みシーンのみ」オプションの動作**:
- ☑チェックあり: `is_completed == true` のシーンのみ出力
- ☐チェックなし: すべてのシーン（プロンプトがあるシーン）を出力

**出力例**（30シーン中、3シーンのみ完成の場合）:
```
# 完成済みシーンのみ出力 → 3行のみ
clothed masturbation, school infirmary, BREAK __posing/arm__, BREAK masterpiece
deepthroat, classroom interior, BREAK __posing/leg__, BREAK best quality
exhibitionism, school rooftop, BREAK standing, spread legs, BREAK best quality
```

**出力履歴**:
プロジェクトファイル内に記録
```json
{
  "metadata": {
    "output_history": [
      {
        "date": "2025-01-15 14:30",
        "output_file": "学園メイド_prompts.txt",
        "output_path": "E:\\works\\学園メイド\\",
        "scenes_count": 30,
        "output_type": "file"
      }
    ]
  }
}
```

---

## 4. UI仕様

### 4.1 画面構成

#### レイアウト: 3カラム（FULLHD: 1920×1080）

```
┌─ Pfft_maker ─ プロジェクト: 学園メイドCG集 ──────────────────────────────────┐
│ メニューバー・ツールバー (高さ: 60px)                    [保存] [出力] [設定] │
├───────────────────────────────────────────────────────────────────────────┤
│                        作業エリア (高さ: 920px)                             │
│ ┌─ライブラリ────┐ ┌─シーン編集────┐ ┌─プレビュー────────┐            │
│ │               │ │                │ │                    │            │
│ │   600px       │ │    750px       │ │      550px         │            │
│ │               │ │                │ │                    │            │
│ │  高さ:        │ │  高さ:         │ │  高さ:             │            │
│ │  820px        │ │  820px         │ │  820px             │            │
│ │               │ │                │ │                    │            │
│ └───────────────┘ └────────────────┘ └────────────────────┘            │
├─ シーン一覧タブ (高さ: 60px) ────────────────────────────────────────────┤
│ [1:保健室] [2:教室] [3:屋上] [4:プール] ... [+新規シーン]                  │
└───────────────────────────────────────────────────────────────────────────┘
```

---

### 4.2 左カラム：ライブラリ（600px）

#### 通常表示（カテゴリ一覧）
```
┌─ライブラリ────────────┐
│ 📂 カテゴリ一覧        │
│                       │
│ 📂 行為 (105)    [→] │
│ 📂 背景 (62)     [→] │
│ 📂 キャラ (4)    [→] │
│ 📂 ポージング(25)[→] │
│ 📂 アングル (15) [→] │
│ 📂 自作 (12)     [→] │
│                       │
│ ──────────────────    │
│ 最近使用:             │
│ • clothed mast... [+] │
│ • school infir... [+] │
│ • SAYA           [+] │
└───────────────────────┘
```

#### 詳細表示（カテゴリ選択時）
```
┌─ライブラリ：行為──────────────┐
│ ◀ カテゴリ一覧                │
│ 🔍 [検索...]  📁[tipo_play ▼] │
│───────────────────────────────│
│ 📁 tipo_play.txt (90)    [+]  │← ファイル全体選択
│                               │   → __tipo_play__
│   ├ 1. ({torogao|aheg... [+] │← 個別選択
│   ├ 14. clothed mast... [+]  │   → 固定テキスト
│   ├ 25. deepthroat...   [+]  │
│   └ ...                       │
│                               │
│ 📁 tipo_1girl.txt (15)   [+]  │
│   ├ 1. standing         [+]  │
│   └ ...                       │
└───────────────────────────────┘
```

**視覚的な区別**:
- **ファイル行**: 📁アイコン + 太字 + [+]ボタン
- **プロンプト行**: インデント + 通常フォント + [+]ボタン

---

### 4.3 中央カラム：シーン編集（750px）

```
┌─シーン編集────────────────┐
│シーン: [1:保健室 ▼]       │
│                           │
│[ブロック1] 📌固定         │
│ clothed masturbation      │
│ [編集][削][↑][↓]        │
│                           │
│[BREAK]                    │
│ [削][↑][↓]              │
│                           │
│[ブロック2] 🎲ワイルド     │
│ __posing/arm__            │
│ [編集][削][↑][↓]        │
│                           │
│[BREAK]                    │
│                           │
│[ブロック3] 📌共通 🔒      │← 共通設定（自動）
│ <lora:futoshi_v1:0.7>    │
│ [個別編集可]              │
│                           │
│[+ブロック] [+BREAK]       │
└───────────────────────────┘
```

**アイコン凡例**:
- 📌 固定テキスト
- 🎲 ワイルドカード（ランダム）
- 🔒 共通プロンプト（全シーン自動適用）

---

### 4.4 右カラム：プレビュー（550px）

```
┌─プレビュー────────────────┐
│【現在編集中のシーン】      │
│clothed masturbation,      │
│BREAK,                     │
│__posing/arm__,            │
│BREAK,                     │
│<lora:futoshi_v1:0.7>,     │
│BREAK,                     │
│masterpiece, best quality  │
│                           │
│文字数: 145 / ~500         │
│[コピー] [このシーンを出力]│
│                           │
│───────────────────────── │
│【ワイルドカード展開候補】  │
│posing/arm (10候補):       │
│ • arms crossed            │
│ • arms up                 │
│ • arms behind back        │
│ （残り7候補...）          │
│                           │
│───────────────────────── │
│【全シーン一覧】(30シーン) │
│                           │
│ 1. clothed mast... ✓      │
│ 2. deepthroat... ✓        │
│ 3. exhibitionism... ★     │← 編集中
│ 4. handjob...             │
│ ...                       │
│ 30. final scene...        │
│                           │
│ 完成: 2/30シーン          │
└───────────────────────────┘
```

**ワイルドカード展開候補の表示ルール**:
- シーン内のワイルドカードブロック（`__filename__`）を検出
- 各ファイルの候補を個別に表示（最大5候補まで）
- 全組み合わせは表示しない（計算量が膨大になるため）

---

### 4.5 ワークフロー

1. **左：ライブラリから探す** → 検索・フィルタリング
2. **中央：シーンに組み立て** → [+]ボタンまたはダブルクリックで挿入
3. **右：リアルタイム確認** → 最終プロンプト表示、コピー
4. **全シーン出力** → [出力]ボタンでファイル生成

---

## 5. データ仕様

### 5.1 ワイルドカードファイル形式

#### 参照元ディレクトリ
```
E:\EasyReforge\Model\wildcards\
```

#### ファイル形式（4パターン）

**パターン1: 番号+テーブル型**
```
9→| 教室 | classroom interior, desks in rows, chalkboard... |
```

**パターン2: テーブル型**
```
| 教室 | classroom interior, desks in rows, chalkboard... |
```

**パターン3: 番号付き型**
```
14→clothed masturbation
25→(deepthroat, irrumatio, vomiting cum...)
```

**パターン4: シンプル型**
```
standing
standing,spread legs
sitting
```

---

### 5.2 プロンプトライブラリCSV

**ファイル名**: `prompts_library.csv`

**カラム構成**:
```csv
id,source_file,original_line_number,original_number,label_ja,label_en,prompt,category,tags,created_date,last_used,label_source
```

**カラム説明**:
- `id`: 一意識別子（`ファイル名_連番`）
- `source_file`: 元ファイルパス（相対パス）
- `original_line_number`: 元ファイルの行番号（**参考情報**、元ファイル変更時は無効）
- `original_number`: 元の番号（`14→`の14、**プロンプト照合に使用**）
- `label_ja`: 日本語ラベル
- `label_en`: 英語ラベル
- `prompt`: プロンプト本体
- `category`: カテゴリ
- `tags`: タグ（カンマ区切り）
- `created_date`: 作成日
- `last_used`: 最終使用日
- `label_source`: ラベル取得方法（`auto_extract` / `ai_generated` / `manual`）

**重要**: `original_line_number`は参考情報であり、プロンプト照合には使用しないでください。照合には`original_number`（`14→`の番号）やプロンプト内容の類似度を使用してください。

---

### 5.3 プロジェクトファイル

**ファイル形式**: JSON（`.pfft`）

**構造**: 前述の FR-010 を参照

---

## 6. 用語集

| 用語 | 説明 |
|------|------|
| **ワイルドカード** | Dynamic Prompts拡張の機能。`__filename__` 形式で記述し、実行時にファイル内容からランダムに1行選択 |
| **ワイルドカード形式** | `__folder/file__` 形式のプロンプト（例: `__posing/arm__`）。拡張子不要、スラッシュ区切り |
| **BREAK** | プロンプトブロックの区切り（大文字必須）。75トークンチャンクの境界を強制、前の文脈の影響を区切る |
| **Prompts from file or textbox** | AUTOMATIC1111の標準スクリプト。改行区切りで複数のプロンプトを読み込み、バッチ生成（1行=1画像） |
| **固定テキスト** | ワイルドカードから特定の1行を選択して展開したプロンプト。常に同じ内容が使用される |
| **シーン** | 1枚の画像を生成するための完全なプロンプトセット。1シーン = 1行 = 1画像 |
| **ブロック** | シーン内のプロンプトの構成要素。固定テキスト、ワイルドカード、BREAKの3種類 |
| **テーブル型** | `| ラベル | プロンプト |` 形式のワイルドカードファイル形式 |
| **番号付き型** | `14→プロンプト` 形式のワイルドカードファイル形式（実環境で確認） |
| **クリーン化** | ワイルドカードファイルからBOM・番号・空行を削除する処理 |

---

## 7. 制約事項

1. **対応OS**: Windows 10/11のみ
2. **推奨解像度**: FULLHD（1920×1080）
3. **最大シーン数**: 30シーン/プロジェクト
4. **ファイルエンコーディング**: UTF-8（BOM付き/なし両対応）
5. **ワイルドカードディレクトリ**: 1プロジェクトにつき1ディレクトリ
6. **AI自動生成**: Claude API / LM Studioへの接続が必要（オプション）

---

## 8. 将来の拡張可能性（参考）

以下は将来的に検討可能な機能（現バージョンでは実装しない）:

- macOS / Linux対応
- 複数ワイルドカードディレクトリの同時管理
- プロンプトの重み付け設定（`(prompt:1.2)`）
- ネガティブプロンプト管理
- 画像生成結果の直接プレビュー
- Stable Diffusion WebUIとの直接連携（API経由）
- クラウド同期機能
- チーム共有機能

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.1 | 2025-01-15 | 仕様確定版（実環境調査反映）<br>- FR-001: 独立コピー方式に変更<br>- FR-005: 手動更新方式に変更<br>- FR-007: ワイルドカード形式確定（`__folder/file__`）<br>- FR-017: Windows ACL対応<br>- FR-018: BREAK処理ルール明確化 |
| 1.0 | 2025-01-15 | 初版作成（確定版） |

---

**承認**:
- 作成者: Claude
- 承認者: （プロジェクトオーナー）
- 承認日: 2025-01-15
