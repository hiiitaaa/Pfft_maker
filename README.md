# Pfft_maker

Stable Diffusion WebUI用のプロンプト管理ツール

## 概要

Pfft_makerは、Stable Diffusion WebUIのワイルドカードファイルを一元管理し、効率的にプロンプトを構築するためのツールです。

**主な機能**:
- ワイルドカードファイルの一元管理
- 日本語ラベル付きで検索・選択を容易化
- 30シーン分のプロンプトを効率的に構築
- 1行1プロンプト形式でファイル出力（Prompts from file形式）

## 開発状況

**Phase 5 完了** (2025-10-14) - 進捗率: 100%

### 完了済み機能

- ✅ **Phase 4.1**: データモデル・コアロジック実装
  - Project, Scene, Block, Prompt モデル
  - ワイルドカードパーサー（4形式対応）
  - プロンプトビルダー（BREAK処理完全対応）

- ✅ **Phase 4.2**: UI実装
  - PyQt6による3カラムレイアウト（1920x1080）
  - ライブラリパネル、シーンエディタ、プレビューパネル
  - プロジェクト管理（保存/読み込み）

- ✅ **Phase 4.3**: シーン編集・出力機能
  - シーン編集機能（ブロック追加・移動・削除）
  - プロンプト出力（ファイル/クリップボード）
  - 検索・カテゴリフィルタ（FR-014, FR-015）
  - 10,942プロンプトの管理・検索
  - CSV高速読み込み（約1秒）

- ✅ **Phase 4.4**: 高度な機能実装
  - ✅ FR-005: ファイル更新チェック・同期機能
    - 起動時自動更新チェック
    - 更新通知バナー表示
    - ユーザーラベル保持（3段階照合）
    - 統合テスト完了（全テスト合格）
  - ✅ FR-012: 共通プロンプト機能
    - 品質タグ自動挿入
    - LoRA自動挿入
    - 新規シーン作成時のテンプレート

- ✅ **Phase 5**: AI連携機能
  - ✅ FR-016: AI自動ラベル生成（Claude API）
  - ✅ FR-017: セキュアAPIキー管理（Fernet AES128）
  - ✅ コスト見積もり機能

- ✅ **FR-004**: 自作プロンプトライブラリ
  - ✅ CustomPromptモデル・マネージャー
  - ✅ 保存ダイアログUI
  - ✅ シーンエディタに💾保存ボタン統合
  - ✅ ライブラリパネルに「自作」カテゴリ表示
  - ✅ 使用履歴記録・タグ自動生成

- ✅ **FR-013**: テンプレート機能 ✅ NEW
  - ✅ ProjectTemplate、SceneTemplate、BlockTemplateモデル
  - ✅ TemplateManagerクラス
  - ✅ テンプレート保存ダイアログ
  - ✅ テンプレート選択ダイアログ
  - ✅ 構成テンプレート（プロンプト内容なし）
  - ✅ 完全テンプレート（プロンプト内容含む）
  - ✅ メインウィンドウ統合
  - ✅ 使用履歴記録

### 次期実装予定
- 🧪 エンドツーエンドテスト
- 🎨 UI/UX改善

## セットアップ

### 必須環境
- Python 3.11以上
- Windows 10/11

### インストール

```bash
# 依存関係のインストール
pip install -r requirements.txt
```

## 📚 ドキュメント

### 初めての方へ
- **[チュートリアル](docs/TUTORIAL.md)** - インストールから画像生成まで、ステップバイステップで学べます（所要時間: 約30分）

### 詳細ガイド
- **[ユーザーガイド](docs/USER_GUIDE.md)** - 全機能の詳細説明、フロー図、トラブルシューティング

### 技術資料
- [機能要件定義書](requirements.md) - 全機能の詳細仕様
- [技術要件定義書](technical_requirements.md) - アーキテクチャ・実装詳細
- [開発ガイド](docs/archive/CLAUDE.md) - 開発者向けガイド

---

## 使用方法

### アプリケーション起動

```bash
# Windowsバッチファイル
run_app.bat

# または直接実行
python run.py
```

### 基本ワークフロー

1. **ライブラリ読み込み**: 左パネル「ライブラリを読み込み」ボタン
2. **検索・フィルタ**: カテゴリ選択、検索バーにキーワード入力
3. **プロンプト挿入**:
   - `[FILE] filename` をダブルクリック → ワイルドカード挿入
   - `個別プロンプト` をダブルクリック → 固定テキスト挿入
   - `✨ 自作プロンプト` をダブルクリック → 保存済みプロンプト挿入
4. **シーン編集**: ブロック移動（↑↓）、BREAK追加、削除
5. **プロンプト保存**: ブロック選択 → 💾「ライブラリに保存」ボタン
6. **テンプレート保存**: メニュー → ファイル → テンプレートとして保存
7. **テンプレートから作成**: メニュー → ファイル → テンプレートから作成
8. **プロンプト出力**: メニュー → ファイル → プロンプト出力 (Ctrl+E)

### テスト実行

```bash
# BREAK処理テスト
python tests/test_break_processing.py

# ライブラリ読み込みテスト
python test_real_wildcards.py
```

## ディレクトリ構成

```
Pfft_maker/
├── src/                      # ソースコード
│   ├── models/               # データモデル（Project, Scene, Block, Prompt）
│   ├── core/                 # コアロジック（Parser, Builder, LibraryManager）
│   ├── ui/                   # UI実装（PyQt6 - 3カラムレイアウト）
│   ├── ai/                   # AI連携（APIキー管理のみ実装済み）
│   ├── config/               # 設定管理
│   └── utils/                # ユーティリティ
├── data/                     # データディレクトリ
│   ├── prompts_library.csv   # プロンプトライブラリ（10,942件）
│   └── settings.json         # 設定ファイル
├── wildcards/                # ローカルワイルドカードファイル
├── tests/                    # テストコード
├── docs/                     # ドキュメント
│   └── archive/              # アーカイブドキュメント
├── requirements.txt          # 依存関係
├── run.py                    # 起動スクリプト
└── README.md                 # このファイル
```

## 設計方針

1. **コードの再利用**: 共通処理はユーティリティに集約
2. **軽量化**: 標準ライブラリ優先、必要最小限の外部ライブラリ
3. **効率的なフォルダ構成**: 責任を明確に分離
4. **ユーザーフロー重視**: 直感的で効率的な操作

## 実装ログ

- [Phase 4.3実装ログ](IMPLEMENTATION_LOG_PHASE4.3.md)
- [AI機能実装ログ](IMPLEMENTATION_LOG_AI_FEATURES.md)
- [FR-005テスト結果](TEST_RESULTS_FR005.md)

## 主要機能

### 実装済み（FR-XXX）
- **FR-001**: ワイルドカードファイル読み込み（4形式対応、10,942件）
- **FR-006-009**: プロンプトブロック管理（固定テキスト、ワイルドカード、BREAK）
- **FR-010-011**: プロジェクト管理（30シーン、JSON保存）
- **FR-014-015**: 検索・カテゴリフィルタ
- **FR-018**: プロンプト出力（ファイル/クリップボード、BREAK処理）

### 実装済み（Phase 4.4）
- **FR-005**: ファイル更新チェック・同期 ✅ NEW
  - 起動時自動更新チェック
  - ユーザーラベル保持（original_number照合、類似度照合）
  - 統合テスト完了
- **FR-012**: 共通プロンプト機能 ✅ NEW

### 実装済み（Phase 5）
- **FR-016**: AI自動ラベル生成（Claude API） ✅
- **FR-017**: セキュアAPIキー管理 ✅

### 実装済み（追加機能）
- **FR-004**: 自作プロンプトライブラリ ✅
  - シーン編集中に作成したプロンプトを保存・再利用
  - ライブラリ統合・使用履歴記録
  - タグ自動生成

- **FR-013**: テンプレート機能 ✅
  - プロジェクト構成をテンプレート化して再利用
  - 構成テンプレート（プロンプト内容なし）
  - 完全テンプレート（プロンプト内容含む）
  - テンプレート管理（保存・読み込み・削除）

## キーボードショートカット

| ショートカット | 機能 |
|--------------|------|
| `Ctrl+N` | 新規プロジェクト |
| `Ctrl+O` | プロジェクトを開く |
| `Ctrl+S` | 保存 |
| `Ctrl+Shift+S` | 名前を付けて保存 |
| `Ctrl+E` | プロンプト出力 |
| `Ctrl+→` | 次のシーン |
| `Ctrl+←` | 前のシーン |

## ライセンス

（未定）

## 作者

Pfft_maker Development Team
